<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Studio Cloud</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <!-- DOMPurify -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <!-- EXPORT LIBRARIES -->
    <!-- html2canvas (Capture DOM as Image) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF (Generate PDF from Images) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- JSZip (Required for Zipping Pages) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver (For saving files) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Mermaid for Diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <style>
        /* --- Base UI --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* --- PDF & Print Critical Rules --- */
        @media print {
            body * {
                visibility: hidden;
            }

            #preview-panel,
            #preview-panel * {
                visibility: visible;
            }

            #preview-panel {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
            }

            #preview-paper {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
                min-height: 0 !important;
            }

            /* Hide the visual page breaks in native print to avoid gaps */
            .print-break {
                display: none !important;
            }

            /* Ensure content doesn't get cut */
            .markdown-body h1,
            .markdown-body h2,
            .markdown-body h3,
            .markdown-body pre,
            .markdown-body table,
            .markdown-body img,
            .markdown-body figure,
            .markdown-body blockquote,
            .mermaid,
            .katex-display {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }

        /* --- Visual Page Breaks for Web View Only --- */
        .print-break {
            background-color: #f1f5f9;
            height: 40px;
            /* Negative margins to pull full width inside the padded container */
            margin-left: -50px;
            margin-right: -50px;
            border-top: 1px dashed #cbd5e1;
            border-bottom: 1px dashed #cbd5e1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            margin-bottom: 20px;
            page-break-before: always;
            /* Helps html2pdf slightly */
        }

        .print-break::after {
            content: "PAGE BREAK";
            font-size: 10px;
            color: #94a3b8;
            font-weight: bold;
            letter-spacing: 2px;
            background: #f1f5f9;
            padding: 0 10px;
        }

        /* --- Markdown Core --- */
        .markdown-body {
            line-height: 1.6;
            width: 100%;
            /* Defaults - Overridden by Dynamic Settings */
            font-size: 16px;
        }

        /* Modern Theme (Default) */
        .theme-modern {
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: #334155;
        }

        .theme-modern h1 {
            font-size: 2.25em;
            font-weight: 800;
            border-bottom: 2px solid #e2e8f0;
            color: #1e293b;
            padding-bottom: 0.3em;
            margin-bottom: 0.8em;
            page-break-after: avoid;
        }

        .theme-modern h2 {
            font-size: 1.75em;
            font-weight: 700;
            border-bottom: 1px solid #e2e8f0;
            color: #1e293b;
            padding-bottom: 0.3em;
            margin-top: 1.5em;
            page-break-after: avoid;
        }

        .theme-modern blockquote {
            border-left: 4px solid #3b82f6;
            background: #f8fafc;
            color: #475569;
            padding: 1rem;
            font-style: italic;
        }

        .theme-modern a {
            color: #2563eb;
            text-decoration: underline;
        }

        .theme-modern code {
            background-color: #f1f5f9;
            color: #ef4444;
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
            font-family: monospace;
            font-size: 0.9em;
        }

        .theme-modern pre {
            background: #1e293b;
            color: #f8fafc;
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1.2em;
            break-inside: avoid;
        }

        /* Academic Theme */
        .theme-academic {
            font-family: 'Georgia', 'Times New Roman', serif;
            color: #111;
            line-height: 1.8;
        }

        .theme-academic h1 {
            font-size: 24pt;
            font-weight: normal;
            text-align: center;
            margin-bottom: 1em;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: none;
        }

        .theme-academic h2 {
            font-size: 16pt;
            font-weight: bold;
            border-bottom: 1px solid #000;
            margin-top: 2em;
            padding-bottom: 5px;
        }

        .theme-academic blockquote {
            border-left: 3px solid #000;
            padding-left: 1em;
            margin-left: 1em;
            font-style: italic;
            background: transparent;
        }

        .theme-academic a {
            color: #000;
            text-decoration: underline;
        }

        .theme-academic code {
            background-color: #eee;
            padding: 2px 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #000;
            border: 1px solid #ddd;
        }

        .theme-academic pre {
            background: #f5f5f5;
            border: 1px solid #ccc;
            color: #000;
            padding: 1em;
        }

        /* Creative Theme */
        .theme-creative {
            font-family: 'Trebuchet MS', sans-serif;
            color: #2d3748;
        }

        .theme-creative h1 {
            font-size: 2.5em;
            color: #4c1d95;
            font-weight: 900;
            margin-bottom: 0.5em;
            border: none;
            text-shadow: 2px 2px 0px #ddd6fe;
        }

        .theme-creative h2 {
            font-size: 1.8em;
            color: #6d28d9;
            border-left: 5px solid #8b5cf6;
            padding-left: 10px;
            margin-top: 1.5em;
        }

        .theme-creative blockquote {
            background: #f3e8ff;
            border-radius: 8px;
            padding: 1.5rem;
            color: #5b21b6;
            border: none;
        }

        .theme-creative a {
            color: #7c3aed;
            font-weight: bold;
            text-decoration: none;
        }

        .theme-creative code {
            background-color: #ede9fe;
            color: #5b21b6;
            padding: 0.2em 0.4em;
            border-radius: 0.25em;
        }

        .theme-creative pre {
            background: #2e1065;
            color: #e9d5ff;
            padding: 1.5em;
            border-radius: 12px;
        }

        /* Common Elements */
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1.2em;
        }

        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 1.2em;
        }

        .markdown-body li {
            margin-bottom: 0.4em;
        }

        .markdown-body img {
            max-width: 100%;
            height: auto;
            margin: 1.5em 0;
            display: block;
            break-inside: avoid;
        }

        .markdown-body table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1.5em;
            break-inside: avoid;
        }

        .markdown-body th,
        .markdown-body td {
            border: 1px solid #cbd5e1;
            padding: 0.75rem;
            text-align: left;
        }

        .markdown-body th {
            background-color: #f1f5f9;
            font-weight: 600;
        }

        /* Mermaid & Math Fixes */
        .mermaid {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }

        .katex-display {
            margin: 1.5em 0;
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* UI Utilities */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .toolbar-btn:hover {
            background-color: #f1f5f9;
            color: #2563eb;
        }

        .drag-overlay {
            position: absolute;
            inset: 0;
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed #3b82f6;
            z-index: 50;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .drag-active .drag-overlay {
            opacity: 1;
        }

        /* Layout Modes */
        .mode-focus #editor-panel {
            width: 100%;
            display: flex;
        }

        .mode-focus #preview-panel {
            display: none;
        }

        .mode-read #editor-panel {
            display: none;
        }

        .mode-read #preview-panel {
            width: 100%;
            display: flex;
        }

        .mode-split #editor-panel {
            display: flex;
        }

        .mode-split #preview-panel {
            display: flex;
        }

        /* Input Ranges */
        input[type="range"] {
            accent-color: #f97316;
        }
    </style>
    <!-- Placeholder for Custom CSS -->
    <style id="custom-css-style"></style>
    <!-- Placeholder for Dynamic Settings -->
    <style id="dynamic-settings-style"></style>
</head>

<body class="bg-slate-100 h-screen flex flex-col overflow-hidden text-slate-800 mode-split" id="app-body">

    <!-- Header -->
    <header
        class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shadow-sm z-30 shrink-0 relative">
        <div class="flex items-center gap-3">
            <div class="bg-orange-500 p-2 rounded-lg text-white shadow-lg shadow-orange-200">
                <i data-lucide="cloud" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Markdown Studio</h1>
                <div class="text-[10px] uppercase font-bold text-orange-500 tracking-wider">Cloud Edition</div>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <div id="status-msg" class="text-sm font-medium text-blue-600 hidden flex items-center gap-2 mr-4">
                <div class="loader"></div> Processing...
            </div>

            <button onclick="cycleViewMode()" class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors"
                title="Switch View">
                <i data-lucide="eye" class="w-5 h-5"></i>
            </button>

            <button onclick="toggleSettings()"
                class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors relative" title="Settings">
                <i data-lucide="settings-2" class="w-5 h-5"></i>
            </button>

            <div class="h-6 w-px bg-slate-200 mx-1"></div>

            <button onclick="downloadMarkdown()"
                class="hidden md:flex items-center gap-2 px-3 py-2 text-slate-600 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-all text-sm font-medium"
                title="Export MD">
                <i data-lucide="file-code" class="w-4 h-4"></i>
                <span class="hidden lg:inline">Export</span>
            </button>

            <!-- Native Print Option (Better Quality) -->
            <button onclick="nativePrint()"
                class="hidden md:flex items-center gap-2 px-3 py-2 text-slate-600 hover:text-green-600 hover:bg-green-50 rounded-lg transition-all text-sm font-medium"
                title="High Quality Print">
                <i data-lucide="printer" class="w-4 h-4"></i>
                <span class="hidden lg:inline">Print / Native PDF</span>
            </button>

            <!-- Image/PDF Export Option (Updated) -->
            <button onclick="openExportModal()"
                class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium shadow-md shadow-orange-200 transition-all flex items-center gap-2 ml-2">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span>Export Img/PDF</span>
            </button>
        </div>
    </header>

    <!-- Settings Panel (REPOSITIONED & CENTERED) -->
    <div id="settings-panel"
        class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 max-w-[90vw] bg-white rounded-xl shadow-2xl border border-slate-100 p-0 scale-95 opacity-0 pointer-events-none transition-all duration-200 z-50 overflow-y-auto max-h-[85vh] flex flex-col">

        <div class="p-4 border-b border-slate-100 bg-slate-50 rounded-t-xl flex justify-between items-center">
            <h3 class="font-bold text-slate-700">Document Settings</h3>
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="p-4 space-y-6 flex-1 overflow-y-auto">
            <!-- Theme Presets -->
            <div>
                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Theme
                    Preset</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="updateSetting('theme', 'modern')"
                        class="theme-btn border border-slate-200 rounded p-2 text-xs font-medium hover:border-orange-500 hover:text-orange-600 transition-colors text-center"
                        data-val="modern">Modern</button>
                    <button onclick="updateSetting('theme', 'academic')"
                        class="theme-btn border border-slate-200 rounded p-2 text-xs font-medium hover:border-orange-500 hover:text-orange-600 transition-colors text-center font-serif"
                        data-val="academic">Academic</button>
                    <button onclick="updateSetting('theme', 'creative')"
                        class="theme-btn border border-slate-200 rounded p-2 text-xs font-medium hover:border-orange-500 hover:text-orange-600 transition-colors text-center font-bold text-purple-700"
                        data-val="creative">Creative</button>
                </div>
            </div>

            <hr class="border-slate-100">

            <!-- Typography -->
            <div>
                <label
                    class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-3 block">Typography</label>

                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-xs text-slate-600">Font Family</span>
                        </div>
                        <select id="font-family-input" onchange="updateSetting('fontFamily', this.value)"
                            class="w-full text-xs border border-slate-200 rounded p-1.5 bg-slate-50 focus:outline-none focus:border-orange-500">
                            <option value="inherit">Use Theme Default</option>
                            <option value="'Segoe UI', system-ui, sans-serif">Sans Serif (Clean)</option>
                            <option value="'Georgia', serif">Serif (Classic)</option>
                            <option value="'Courier New', monospace">Monospace (Code)</option>
                        </select>
                    </div>

                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-xs text-slate-600">Font Size</span>
                            <span class="text-xs font-mono text-slate-400" id="font-size-display">16px</span>
                        </div>
                        <input id="font-size-input" type="range" min="12" max="24" value="16"
                            class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                            oninput="updateSetting('fontSize', this.value)">
                    </div>

                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-xs text-slate-600">Line Height</span>
                            <span class="text-xs font-mono text-slate-400" id="line-height-display">1.6</span>
                        </div>
                        <input id="line-height-input" type="range" min="1.0" max="2.5" step="0.1" value="1.6"
                            class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                            oninput="updateSetting('lineHeight', this.value)">
                    </div>
                </div>
            </div>

            <hr class="border-slate-100">

            <!-- Layout -->
            <div>
                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-3 block">Layout</label>

                <div class="space-y-4">
                    <div class="flex bg-slate-100 rounded-lg p-1">
                        <button onclick="updateSetting('paper', 'a4')"
                            class="paper-btn flex-1 text-xs font-medium py-1.5 rounded-md transition-all text-slate-500 hover:text-slate-700"
                            data-val="a4">A4</button>
                        <button onclick="updateSetting('paper', 'letter')"
                            class="paper-btn flex-1 text-xs font-medium py-1.5 rounded-md transition-all text-slate-500 hover:text-slate-700"
                            data-val="letter">Letter</button>
                    </div>

                    <div>
                        <div class="flex justify-between mb-1">
                            <span class="text-xs text-slate-600">Page Margins</span>
                            <span class="text-xs font-mono text-slate-400" id="margins-display">50px</span>
                        </div>
                        <input id="margins-input" type="range" min="20" max="100" value="50"
                            class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                            oninput="updateSetting('margins', this.value)">
                    </div>
                </div>
            </div>

            <hr class="border-slate-100">

            <!-- Advanced -->
            <div>
                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block">Custom
                    CSS</label>
                <textarea id="custom-css-input"
                    class="w-full h-20 text-[10px] font-mono border border-slate-200 rounded p-2 bg-slate-50 focus:outline-none focus:border-orange-400"
                    placeholder=".markdown-body h1 { color: red; }"></textarea>
            </div>
        </div>

        <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-xl">
            <p class="text-[10px] text-slate-400 text-center mb-3">ID: <span id="user-id-display">...</span></p>
            <button onclick="clearCloudData()"
                class="w-full py-2 text-xs font-medium text-red-600 hover:bg-red-50 rounded border border-red-200 transition-colors">Reset
                Everything</button>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal"
        class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform duration-300"
            id="export-modal-content">
            <div class="bg-slate-50 border-b border-slate-100 px-6 py-4 flex items-center justify-between">
                <h3 class="font-bold text-slate-700">Export Options</h3>
                <button onclick="closeExportModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-3">
                <button onclick="generateLongImage()"
                    class="w-full flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-orange-50 hover:border-orange-200 hover:text-orange-700 transition-all group text-left">
                    <div class="bg-orange-100 text-orange-600 p-2 rounded-md group-hover:bg-orange-200">
                        <i data-lucide="scroll" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <div class="font-bold text-sm">Single Continuous Image</div>
                        <div class="text-xs text-slate-500">Entire document as one PNG file</div>
                    </div>
                </button>

                <button onclick="generatePagedImages()"
                    class="w-full flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-blue-50 hover:border-blue-200 hover:text-blue-700 transition-all group text-left">
                    <div class="bg-blue-100 text-blue-600 p-2 rounded-md group-hover:bg-blue-200">
                        <i data-lucide="files" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <div class="font-bold text-sm">Paged Images (ZIP)</div>
                        <div class="text-xs text-slate-500">Separate PNG for each page</div>
                    </div>
                </button>

                <button onclick="generateImagePDF()"
                    class="w-full flex items-center gap-3 p-3 rounded-lg border border-slate-200 hover:bg-red-50 hover:border-red-200 hover:text-red-700 transition-all group text-left">
                    <div class="bg-red-100 text-red-600 p-2 rounded-md group-hover:bg-red-200">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <div class="font-bold text-sm">PDF Document</div>
                        <div class="text-xs text-slate-500">Standard PDF file</div>
                    </div>
                </button>
            </div>
            <div class="bg-slate-50 px-6 py-3 text-center border-t border-slate-100">
                <button onclick="closeExportModal()"
                    class="text-xs font-medium text-slate-500 hover:text-slate-800">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Main Workspace -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden" onclick="closeSettingsOutside(event)">

        <!-- Editor Section -->
        <div id="editor-panel" class="flex-1 flex-col border-r border-slate-200 bg-white min-w-0 relative">
            <div class="drag-overlay">
                <div class="text-center">
                    <i data-lucide="image-plus" class="w-10 h-10 text-orange-500 mx-auto mb-2"></i>
                    <p class="text-orange-600 font-bold">Drop Image to Upload</p>
                </div>
            </div>

            <!-- Toolbar -->
            <div
                class="h-10 border-b border-slate-100 flex items-center px-2 gap-1 bg-white overflow-x-auto shrink-0 scrollbar-hide">
                <button onclick="insertFormat('bold')" class="toolbar-btn p-1.5 rounded text-slate-500" title="Bold"><i
                        data-lucide="bold" class="w-4 h-4"></i></button>
                <button onclick="insertFormat('italic')" class="toolbar-btn p-1.5 rounded text-slate-500"
                    title="Italic"><i data-lucide="italic" class="w-4 h-4"></i></button>
                <div class="w-px h-4 bg-slate-200 mx-1"></div>
                <button onclick="insertFormat('h1')" class="toolbar-btn p-1.5 rounded text-slate-500" title="H1"><i
                        data-lucide="heading-1" class="w-4 h-4"></i></button>
                <button onclick="insertFormat('h2')" class="toolbar-btn p-1.5 rounded text-slate-500" title="H2"><i
                        data-lucide="heading-2" class="w-4 h-4"></i></button>
                <div class="w-px h-4 bg-slate-200 mx-1"></div>
                <button onclick="insertFormat('list-ul')" class="toolbar-btn p-1.5 rounded text-slate-500"
                    title="List"><i data-lucide="list" class="w-4 h-4"></i></button>
                <button onclick="insertFormat('quote')" class="toolbar-btn p-1.5 rounded text-slate-500"
                    title="Quote"><i data-lucide="quote" class="w-4 h-4"></i></button>
                <div class="w-px h-4 bg-slate-200 mx-1"></div>
                <button onclick="insertFormat('toc')"
                    class="toolbar-btn p-1.5 rounded text-orange-500 bg-orange-50 hover:bg-orange-100"
                    title="Table of Contents"><i data-lucide="list-tree" class="w-4 h-4"></i></button>
                <button onclick="insertFormat('code')" class="toolbar-btn p-1.5 rounded text-slate-500" title="Code"><i
                        data-lucide="code" class="w-4 h-4"></i></button>
                <button onclick="insertFormat('math')" class="toolbar-btn p-1.5 rounded text-slate-500" title="Math"><i
                        data-lucide="sigma" class="w-4 h-4"></i></button>
                <button onclick="insertFormat('mermaid')" class="toolbar-btn p-1.5 rounded text-slate-500"
                    title="Mermaid"><i data-lucide="network" class="w-4 h-4"></i></button>
                <button onclick="insertFormat('table')" class="toolbar-btn p-1.5 rounded text-slate-500"
                    title="Table"><i data-lucide="table" class="w-4 h-4"></i></button>
                <button onclick="insertFormat('image')" class="toolbar-btn p-1.5 rounded text-slate-500"
                    title="Image URL"><i data-lucide="image" class="w-4 h-4"></i></button>
                <div class="w-px h-4 bg-slate-200 mx-1"></div>
                <button onclick="hideImageCode()"
                    class="toolbar-btn p-1.5 rounded text-purple-500 hover:text-purple-600 hover:bg-purple-50"
                    title="Clean Image Codes"><i data-lucide="wand-2" class="w-4 h-4"></i></button>
            </div>

            <!-- Text Area -->
            <textarea id="editor"
                class="flex-1 w-full p-6 resize-none focus:outline-none font-mono text-sm leading-relaxed text-slate-700 bg-white"
                placeholder="Logging into Cloud..." spellcheck="false" disabled></textarea>

            <!-- Status Bar -->
            <div
                class="h-8 bg-slate-50 border-t border-slate-200 flex items-center justify-between px-4 text-xs text-slate-400 font-mono shrink-0">
                <div class="flex gap-4 items-center">
                    <span id="word-count" class="cursor-pointer hover:text-orange-600 transition-colors"
                        onclick="setWordTarget()">0 Words</span>
                    <span id="char-count">0 Chars</span>
                    <div id="target-container" class="hidden items-center gap-2">
                        <div class="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-green-500 w-0 transition-all duration-500"></div>
                        </div>
                        <span id="target-text" class="text-[10px]">0%</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="cloud-status" class="flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-slate-300 transition-colors" id="cloud-dot"></span>
                        <span id="cloud-text">Connecting...</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div id="preview-panel"
            class="flex-1 bg-slate-100 overflow-y-auto relative flex flex-col items-center py-10 px-4 scroll-smooth">
            <div id="preview-paper"
                class="w-full max-w-[210mm] min-h-[297mm] h-auto bg-white shadow-xl rounded-sm p-[15mm] md:p-[50px] transition-all duration-300 flex-shrink-0">
                <div id="preview-content" class="markdown-body theme-modern">
                    <!-- Content injected here -->
                </div>
            </div>
            <div class="mt-6 text-xs text-slate-400 font-medium pb-8 uppercase tracking-widest opacity-60">
                Preview &middot; <span id="paper-label">A4</span>
            </div>
        </div>

    </main>

    <!-- Notification Toast (Updated) -->
    <div id="toast"
        class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-5 py-2.5 rounded-full text-sm font-medium shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-2">
        <span id="toast-icon-container" class="flex items-center justify-center">
            <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
        </span>
        <span id="toast-msg">Action Successful</span>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCv_0Cn6SRenJBVLojJoT2h4C0vtkafiZs",
            authDomain: "glitch-10327.firebaseapp.com",
            projectId: "glitch-10327",
            storageBucket: "glitch-10327.firebasestorage.app",
            messagingSenderId: "304917207309",
            appId: "1:304917207309:web:6244380c8ac459dc693844",
            measurementId: "G-DHSXSMFNCE"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let currentUser = null;
        let unsubscribeDoc = null;
        let imageCache = {};
        let isSaving = false;
        let wordTarget = 0;
        let viewModes = ['mode-split', 'mode-focus', 'mode-read'];
        let currentModeIndex = 0;
        let resizeObserver;

        // Settings State
        let settings = {
            theme: 'modern',
            paper: 'a4',
            fontSize: 16,
            lineHeight: 1.6,
            margins: 50,
            fontFamily: 'inherit'
        };

        // --- Elements ---
        const editor = document.getElementById('editor');
        const cloudText = document.getElementById('cloud-text');
        const cloudDot = document.getElementById('cloud-dot');
        const userIdDisplay = document.getElementById('user-id-display');

        // --- Auth & Init ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        return;
                    } catch (e) {
                        console.warn("Custom token auth failed. Falling back to Anonymous.", e);
                    }
                }
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error", error);
                cloudText.textContent = "Auth Error";
                cloudDot.classList.remove('bg-slate-300', 'bg-yellow-400');
                cloudDot.classList.add('bg-red-500');
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                userIdDisplay.textContent = user.uid.substring(0, 8) + '...';
                editor.disabled = false;
                editor.placeholder = "Start typing or drop an image...";
                cloudText.textContent = "Syncing...";
                cloudDot.classList.remove('bg-red-500');
                cloudDot.classList.add('bg-yellow-400');

                await loadImages(user.uid);
                setupRealtimeListener(user.uid);
            } else {
                editor.disabled = true;
                editor.placeholder = "Logging in...";
            }
        });

        async function loadImages(uid) {
            if (!appId) return;
            const imagesRef = collection(db, 'artifacts', appId, 'users', uid, 'images');
            try {
                const querySnapshot = await getDocs(query(imagesRef));
                querySnapshot.forEach((doc) => { imageCache[doc.id] = doc.data().base64; });
            } catch (e) { console.error("Error loading images:", e); }
        }

        function setupRealtimeListener(uid) {
            if (!appId) return;
            const docRef = doc(db, 'artifacts', appId, 'users', uid, 'data', 'content');
            unsubscribeDoc = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // Update Text
                    if (document.activeElement !== editor) {
                        editor.value = data.text || '';
                    }

                    // Update CSS
                    if (data.css) {
                        document.getElementById('custom-css-input').value = data.css;
                        document.getElementById('custom-css-style').textContent = data.css;
                    }

                    // Update Settings
                    if (data.settings) {
                        // Merge with default to ensure new keys exist
                        settings = { ...settings, ...data.settings };
                        applySettingsUI();
                        updatePreviewStyles();
                    }

                    if (document.activeElement !== editor) render();
                    updateStatus('Saved', 'bg-green-500');
                } else {
                    updateStatus('Ready', 'bg-green-500');
                }
            }, (error) => {
                console.error("Sync Error:", error);
                if (error.code === 'permission-denied') {
                    updateStatus('Local Mode', 'bg-orange-400');
                } else {
                    updateStatus('Offline', 'bg-red-500');
                }
            });
        }

        let saveTimeout;
        function triggerSave() {
            if (!currentUser) return;
            updateStatus('Syncing...', 'bg-yellow-400');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'content');
                    await setDoc(docRef, {
                        text: editor.value,
                        css: document.getElementById('custom-css-input').value,
                        settings: settings,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                    updateStatus('Cloud Saved', 'bg-green-500');
                } catch (e) {
                    if (e.code === 'permission-denied') {
                        updateStatus('Local Mode', 'bg-orange-400');
                    } else {
                        updateStatus('Save Error', 'bg-red-500');
                    }
                }
            }, 1000);
        }

        async function saveImageToCloud(id, base64) {
            if (!currentUser) return;
            updateStatus('Uploading Img...', 'bg-yellow-400');
            try {
                const imgRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'images', id);
                await setDoc(imgRef, { base64: base64 });
                updateStatus('Cloud Saved', 'bg-green-500');
            } catch (e) {
                updateStatus('Upload Failed', 'bg-red-500');
            }
        }

        function updateStatus(text, colorClass) {
            cloudText.textContent = text;
            cloudDot.className = `w-1.5 h-1.5 rounded-full transition-colors ${colorClass}`;
        }

        window.clearCloudData = async function () {
            if (!currentUser || !confirm("Reset document and settings?")) return;
            editor.value = "# New Document\nStart typing...";
            settings = { theme: 'modern', paper: 'a4', fontSize: 16, lineHeight: 1.6, margins: 50, fontFamily: 'inherit' };

            // Reset Custom CSS
            document.getElementById('custom-css-input').value = '';
            document.getElementById('custom-css-style').textContent = '';

            applySettingsUI();
            updatePreviewStyles();
            triggerSave();
            render();
        }

        // --- SETTINGS LOGIC (FIXED) ---

        // FIX 1: Correct Visibility Toggle logic (Handling pointer-events)
        window.toggleSettings = () => {
            const panel = document.getElementById('settings-panel');
            const isClosed = panel.classList.contains('opacity-0');

            if (isClosed) {
                // Opening
                panel.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                panel.classList.add('scale-100');
            } else {
                // Closing
                panel.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                panel.classList.remove('scale-100');
            }
        };

        window.closeSettingsOutside = (e) => {
            // Only close if clicking outside AND panel is open AND not clicking toggle btn
            const panel = document.getElementById('settings-panel');
            const btn = document.querySelector('button[onclick="toggleSettings()"]');

            if (!panel.contains(e.target) && !btn.contains(e.target) && !panel.classList.contains('opacity-0')) {
                panel.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                panel.classList.remove('scale-100');
            }

            // Handle Export Modal closing here too
            if (!document.getElementById('export-modal-content').contains(e.target) && !e.target.closest('button[onclick="openExportModal()"]')) {
                const modal = document.getElementById('export-modal');
                if (!modal.classList.contains('hidden')) {
                    closeExportModal();
                }
            }
        };

        window.updateSetting = function (key, value) {
            // FIX 2: Ensure numeric values are stored as numbers
            if (key === 'fontSize' || key === 'margins' || key === 'lineHeight') {
                settings[key] = parseFloat(value);
            } else {
                settings[key] = value;
            }

            // UI Updates
            if (key === 'theme') {
                document.querySelectorAll('.theme-btn').forEach(b => {
                    if (b.dataset.val === value) b.classList.add('border-orange-500', 'text-orange-600', 'bg-orange-50');
                    else b.classList.remove('border-orange-500', 'text-orange-600', 'bg-orange-50');
                });
            }
            if (key === 'paper') {
                document.querySelectorAll('.paper-btn').forEach(b => {
                    if (b.dataset.val === value) b.classList.add('bg-white', 'shadow-sm', 'text-slate-800');
                    else b.classList.remove('bg-white', 'shadow-sm', 'text-slate-800');
                });
                const label = document.getElementById('paper-label');
                label.textContent = value === 'a4' ? 'A4' : 'Letter';
            }

            if (key === 'fontSize') document.getElementById('font-size-display').textContent = value + 'px';
            if (key === 'lineHeight') document.getElementById('line-height-display').textContent = value;
            if (key === 'margins') document.getElementById('margins-display').textContent = value + 'px';

            updatePreviewStyles();
            triggerSave();

            // Debounce repagination for sliders to improve performance
            if (key !== 'theme' && key !== 'paper') {
                clearTimeout(window.repaginateTimeout);
                window.repaginateTimeout = setTimeout(repaginate, 200);
            } else {
                repaginate();
            }
        };

        function applySettingsUI() {
            // Theme Buttons
            document.querySelectorAll('.theme-btn').forEach(b => {
                if (b.dataset.val === settings.theme) b.classList.add('border-orange-500', 'text-orange-600', 'bg-orange-50');
                else b.classList.remove('border-orange-500', 'text-orange-600', 'bg-orange-50');
            });

            // Paper Buttons
            document.querySelectorAll('.paper-btn').forEach(b => {
                if (b.dataset.val === settings.paper) b.classList.add('bg-white', 'shadow-sm', 'text-slate-800');
                else b.classList.remove('bg-white', 'shadow-sm', 'text-slate-800');
            });

            // Inputs
            document.getElementById('font-size-input').value = settings.fontSize;
            document.getElementById('font-size-display').textContent = settings.fontSize + 'px';

            document.getElementById('line-height-input').value = settings.lineHeight;
            document.getElementById('line-height-display').textContent = settings.lineHeight;

            document.getElementById('margins-input').value = settings.margins;
            document.getElementById('margins-display').textContent = settings.margins + 'px';

            document.getElementById('font-family-input').value = settings.fontFamily || 'inherit';
        }

        function updatePreviewStyles() {
            const content = document.getElementById('preview-content');
            const paper = document.getElementById('preview-paper');
            const styleBlock = document.getElementById('dynamic-settings-style');

            // Apply Theme Class
            content.className = `markdown-body theme-${settings.theme}`;

            // Apply Paper Size
            if (settings.paper === 'a4') {
                paper.style.maxWidth = '210mm';
                paper.style.minHeight = '297mm';
            } else {
                paper.style.maxWidth = '215.9mm';
                paper.style.minHeight = '279.4mm';
            }

            // Apply Dynamic CSS
            paper.style.padding = `${settings.margins}px`;

            const fontFamilyRule = settings.fontFamily !== 'inherit' ? `font-family: ${settings.fontFamily} !important;` : '';

            styleBlock.textContent = `
                .markdown-body {
                    font-size: ${settings.fontSize}px !important;
                    line-height: ${settings.lineHeight} !important;
                    ${fontFamilyRule}
                }
            `;
        }


        // --- MARKDOWN & RENDER LOGIC ---
        marked.setOptions({ breaks: true, gfm: true });

        const renderer = new marked.Renderer();
        const originalCode = renderer.code.bind(renderer);
        renderer.code = (code, language) => {
            if (language === 'mermaid') return `<div class="mermaid">${code}</div>`;
            return originalCode(code, language);
        };
        // Add ID to headings for TOC
        renderer.heading = (text, level) => {
            const slug = text.toLowerCase().replace(/[^\w]+/g, '-');
            return `<h${level} id="${slug}">${text}</h${level}>`;
        };
        marked.use({ renderer });

        // --- IMPROVED PAGINATION LOGIC ---
        // Uses ResizeObserver instead of unreliable timeouts
        function initPaginationObserver() {
            const content = document.getElementById('preview-content');
            if (resizeObserver) resizeObserver.disconnect();

            resizeObserver = new ResizeObserver(entries => {
                // Debounce repaginate to avoid flickering loops
                window.requestAnimationFrame(() => {
                    repaginate();
                });
            });

            resizeObserver.observe(content);
        }

        function repaginate() {
            // Only perform visual pagination for screen, NOT during print if possible
            if (window.matchMedia('print').matches) return;

            const content = document.getElementById('preview-content');
            const elements = Array.from(content.children);

            // Cleanup old breaks first
            elements.forEach(el => {
                if (el.classList.contains('print-break')) el.remove();
            });

            // Re-fetch clean list
            const cleanElements = Array.from(content.children);

            // Calculate usable height based on margins
            const A4_PX = 1123;
            const verticalMargins = (settings.margins * 2);
            const CONTENT_HEIGHT = A4_PX - verticalMargins;

            let currentHeight = 0;

            cleanElements.forEach((el) => {
                // Skip absolute positioned elements or hidden ones
                if (el.style.display === 'none') return;

                const rect = el.getBoundingClientRect();
                const style = window.getComputedStyle(el);
                const marginTop = parseInt(style.marginTop) || 0;
                const marginBottom = parseInt(style.marginBottom) || 0;

                // Effective height of this block
                const totalElHeight = rect.height + marginTop + marginBottom;

                if (currentHeight + totalElHeight > CONTENT_HEIGHT) {
                    // Insert break
                    const breakEl = document.createElement('div');
                    breakEl.className = 'print-break';
                    content.insertBefore(breakEl, el);

                    // Reset height to this element's height (it's now on the next page)
                    currentHeight = totalElHeight;
                } else {
                    currentHeight += totalElHeight;
                }
            });
        }

        async function render() {
            try {
                let rawMarkdown = editor.value;
                updateStats(rawMarkdown);

                const cacheDefinitions = Object.entries(imageCache)
                    .map(([id, data]) => `[${id}]: ${data}`)
                    .join('\n');

                rawMarkdown = rawMarkdown + '\n\n' + cacheDefinitions;

                // Math Protection
                const mathBlocks = [];
                rawMarkdown = rawMarkdown.replace(/\$\$([\s\S]+?)\$\$/g, (match) => {
                    mathBlocks.push(match);
                    return `%%%MATH${mathBlocks.length - 1}%%%`;
                });
                rawMarkdown = rawMarkdown.replace(/\$([^$\n]+?)\$/g, (match) => {
                    mathBlocks.push(match);
                    return `%%%MATH${mathBlocks.length - 1}%%%`;
                });

                let html = marked.parse(rawMarkdown);

                mathBlocks.forEach((block, index) => {
                    html = html.replace(`%%%MATH${index}%%%`, block);
                });

                const contentDiv = document.getElementById('preview-content');
                contentDiv.innerHTML = html;

                // Render diagrams & math
                try {
                    // Force mermaid to re-render
                    await mermaid.run({ nodes: document.querySelectorAll('.mermaid') });

                    renderMathInElement(contentDiv, {
                        delimiters: [
                            { left: '$$', right: '$$', display: true },
                            { left: '$', right: '$', display: false }
                        ],
                        throwOnError: false
                    });
                } catch (e) { console.warn("Render warn:", e); }

                // Check for images and ensure they load before paginating
                const images = contentDiv.querySelectorAll('img');
                if (images.length > 0) {
                    let loaded = 0;
                    images.forEach(img => {
                        // Prevent Tainted Canvas on regular images
                        img.crossOrigin = "Anonymous";
                        if (img.complete) loaded++;
                        else img.onload = () => {
                            loaded++;
                            if (loaded === images.length) repaginate();
                        }
                    });
                } else {
                    repaginate();
                }

            } catch (err) { console.error("Render error", err); }
        }

        // --- NATIVE PRINT (High Quality) ---
        window.nativePrint = function () {
            window.print();
        }

        // --- EXPORT LOGIC (Shared & Robust) ---

        window.openExportModal = function () {
            const modal = document.getElementById('export-modal');
            const content = document.getElementById('export-modal-content');
            modal.classList.remove('hidden');
            // Trigger reflow for transition
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
        };

        window.closeExportModal = function () {
            const modal = document.getElementById('export-modal');
            const content = document.getElementById('export-modal-content');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        async function convertSvgsToImages(container) {
            // Pre-process regular images to ensure CORS compliance
            const imgs = container.querySelectorAll('img');
            imgs.forEach(img => {
                if (!img.src.startsWith('data:')) {
                    img.crossOrigin = "Anonymous";
                }
            });

            const svgs = container.querySelectorAll('.mermaid svg');
            if (svgs.length > 0) {
                await Promise.all(Array.from(svgs).map(svg => {
                    return new Promise(resolve => {
                        try {
                            const rect = svg.getBoundingClientRect();
                            const width = rect.width > 0 ? rect.width : (parseInt(svg.style.maxWidth) || parseInt(svg.getAttribute('width')) || 800);
                            const height = rect.height > 0 ? rect.height : (parseInt(svg.style.height) || parseInt(svg.getAttribute('height')) || 600);

                            const canvas = document.createElement('canvas');
                            const scale = 2; // High quality
                            canvas.width = width * scale;
                            canvas.height = height * scale;
                            const ctx = canvas.getContext('2d');
                            ctx.scale(scale, scale);

                            // White background prevents transparent PNG issues
                            ctx.fillStyle = 'white';
                            ctx.fillRect(0, 0, width, height);

                            const xmlSerializer = new XMLSerializer();
                            let xml = xmlSerializer.serializeToString(svg);
                            const svgBlob = new Blob([xml], { type: 'image/svg+xml;charset=utf-8' });
                            const url = URL.createObjectURL(svgBlob);

                            const img = new Image();
                            img.crossOrigin = "Anonymous"; // Fix for Tainting
                            img.onload = () => {
                                ctx.drawImage(img, 0, 0, width, height);
                                URL.revokeObjectURL(url);
                                const replacementImg = document.createElement('img');
                                try {
                                    replacementImg.src = canvas.toDataURL('image/png');
                                } catch (e) {
                                    console.warn("Canvas Tainted, falling back to original SVG", e);
                                    resolve(); // Resolve without replacing
                                    return;
                                }
                                replacementImg.style.width = width + 'px';
                                replacementImg.style.maxWidth = '100%';
                                if (svg.parentNode) svg.parentNode.replaceChild(replacementImg, svg);
                                resolve();
                            };
                            img.onerror = () => { URL.revokeObjectURL(url); resolve(); };
                            img.src = url;
                        } catch (e) { resolve(); }
                    });
                }));
            }
        }

        // Helper: Prepares Paginated Clones for Export
        function createExportPages() {
            repaginate();
            const sourceContent = document.getElementById('preview-content');
            const nodes = Array.from(sourceContent.childNodes).map(n => n.cloneNode(true));

            const workspace = document.createElement('div');
            workspace.style.position = 'absolute';
            workspace.style.top = '0';
            workspace.style.left = '0';
            workspace.style.zIndex = '-9999';
            document.body.appendChild(workspace);

            let pages = [];
            let currentPage = document.createElement('div');
            // Match Settings logic
            currentPage.className = 'markdown-body ' + sourceContent.className;
            currentPage.style.width = settings.paper === 'a4' ? '210mm' : '215.9mm';
            currentPage.style.minHeight = settings.paper === 'a4' ? '297mm' : '279.4mm';
            currentPage.style.background = 'white';
            currentPage.style.padding = settings.margins + 'px';

            pages.push(currentPage);
            workspace.appendChild(currentPage);

            nodes.forEach(node => {
                if (node.nodeType === 1 && node.classList.contains('print-break')) {
                    currentPage = document.createElement('div');
                    currentPage.className = 'markdown-body ' + sourceContent.className;
                    currentPage.style.width = settings.paper === 'a4' ? '210mm' : '215.9mm';
                    currentPage.style.minHeight = settings.paper === 'a4' ? '297mm' : '279.4mm';
                    currentPage.style.background = 'white';
                    currentPage.style.padding = settings.margins + 'px';
                    pages.push(currentPage);
                    workspace.appendChild(currentPage);
                } else {
                    currentPage.appendChild(node);
                }
            });

            return { workspace, pages };
        }

        // 1. Single Long Image Generator
        window.generateLongImage = async function () {
            closeExportModal();
            showToast('Generating Long Image...', false);
            const statusMsg = document.getElementById('status-msg');
            statusMsg.classList.remove('hidden');

            try {
                const cloneContainer = document.createElement('div');
                cloneContainer.style.position = 'absolute';
                cloneContainer.style.top = '0';
                cloneContainer.style.left = '0';
                cloneContainer.style.zIndex = '-9999';
                cloneContainer.style.width = settings.paper === 'a4' ? '210mm' : '215.9mm';
                cloneContainer.style.background = 'white';
                cloneContainer.style.padding = settings.margins + 'px';

                const sourceContent = document.getElementById('preview-content');
                cloneContainer.className = 'markdown-body ' + sourceContent.className;
                cloneContainer.innerHTML = sourceContent.innerHTML;
                document.body.appendChild(cloneContainer);

                cloneContainer.querySelectorAll('.print-break').forEach(el => el.remove());
                await convertSvgsToImages(cloneContainer);
                await new Promise(resolve => setTimeout(resolve, 500));

                const canvas = await html2canvas(cloneContainer, { scale: 2, useCORS: true });

                canvas.toBlob(function (blob) {
                    saveAs(blob, "document-full.png");
                    showToast('Image Downloaded');
                    statusMsg.classList.add('hidden');
                    cloneContainer.remove();
                });

            } catch (e) {
                console.error(e);
                showToast('Export Error', true);
                statusMsg.classList.add('hidden');
            }
        };

        // 2. Paged Images Generator (ZIP)
        window.generatePagedImages = async function () {
            closeExportModal();
            showToast('Generating Pages...', false);
            const statusMsg = document.getElementById('status-msg');
            statusMsg.classList.remove('hidden');

            try {
                const { workspace, pages } = createExportPages();
                await convertSvgsToImages(workspace);
                await new Promise(resolve => setTimeout(resolve, 500));

                const zip = new JSZip();

                for (let i = 0; i < pages.length; i++) {
                    cloudText.textContent = `Rendering Pg ${i + 1}/${pages.length}`;
                    const canvas = await html2canvas(pages[i], { scale: 2, useCORS: true });
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    zip.file(`page-${i + 1}.png`, blob);
                }

                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, "document-pages.zip");

                showToast('ZIP Downloaded');
                statusMsg.classList.add('hidden');
                workspace.remove();
                cloudText.textContent = "Saved";

            } catch (e) {
                console.error(e);
                showToast('Page Export Error', true);
                statusMsg.classList.add('hidden');
            }
        };

        // 3. PDF Generator (MANUAL & ROBUST)
        window.generateImagePDF = async function () {
            closeExportModal();
            showToast('Generating PDF...', false);
            const statusMsg = document.getElementById('status-msg');
            statusMsg.classList.remove('hidden');

            // Save layout state
            const originalBodyOverflow = document.body.style.overflow;
            document.body.style.overflow = 'visible';
            window.scrollTo(0, 0);

            try {
                const { workspace, pages } = createExportPages();
                await convertSvgsToImages(workspace);
                await new Promise(resolve => setTimeout(resolve, 500));

                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const format = settings.paper; // 'a4' or 'letter'
                const doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: format
                });

                const pageWidth = format === 'a4' ? 210 : 215.9;
                const pageHeight = format === 'a4' ? 297 : 279.4;

                for (let i = 0; i < pages.length; i++) {
                    cloudText.textContent = `PDF Pg ${i + 1}/${pages.length}`;

                    const canvas = await html2canvas(pages[i], {
                        scale: 2,
                        useCORS: true,
                        // Fix for some white-page issues: explicit dimensions
                        width: pages[i].offsetWidth,
                        height: pages[i].offsetHeight
                    });

                    const imgData = canvas.toDataURL('image/png');

                    if (i > 0) doc.addPage();
                    doc.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);
                }

                doc.save('document.pdf');
                showToast('PDF Downloaded');
                workspace.remove();

            } catch (err) {
                console.error("PDF Generation Error:", err);
                showToast('PDF Error', true);
            } finally {
                document.body.style.overflow = originalBodyOverflow;
                statusMsg.classList.add('hidden');
                cloudText.textContent = "Saved";
            }
        };

        window.downloadMarkdown = function () {
            const cacheDefinitions = Object.entries(imageCache).map(([id, data]) => `[${id}]: ${data}`).join('\n');
            const finalText = editor.value + '\n\n' + cacheDefinitions;
            const blob = new Blob([finalText], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        window.cycleViewMode = function () {
            document.body.classList.remove(viewModes[currentModeIndex]);
            currentModeIndex = (currentModeIndex + 1) % viewModes.length;
            document.body.classList.add(viewModes[currentModeIndex]);
            showToast(['Split View', 'Focus Mode', 'Read Mode'][currentModeIndex]);
        };

        // --- UI & Helpers ---
        // REMOVED DUPLICATE FUNCTION DEFINITIONS HERE TO FIX SETTINGS PANEL
        document.getElementById('custom-css-input').addEventListener('input', (e) => {
            document.getElementById('custom-css-style').textContent = e.target.value;
            triggerSave();
        });
        window.setWordTarget = function () {
            const input = prompt("Target word count:", wordTarget || 500);
            wordTarget = parseInt(input) || 0;
            if (wordTarget > 0) document.getElementById('target-container').classList.remove('hidden');
            else document.getElementById('target-container').classList.add('hidden');
            updateStats(editor.value);
        };
        function updateStats(text) {
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            document.getElementById('word-count').textContent = `${words} Words`;
            document.getElementById('char-count').textContent = `${text.length} Chars`;
            if (wordTarget > 0) {
                const percent = Math.min((words / wordTarget) * 100, 100);
                document.getElementById('progress-bar').style.width = `${percent}%`;
                document.getElementById('target-text').textContent = `${Math.floor(percent)}%`;
            }
        }
        window.setTheme = (theme) => {
            updateSetting('theme', theme);
        };
        window.setPaper = (size) => {
            updateSetting('paper', size);
        };
        function showToast(msg, err) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;

            // FIX: Rebuild the icon HTML to prevent crash on subsequent calls
            const iconContainer = document.getElementById('toast-icon-container');
            const iconName = err ? 'alert-circle' : 'check-circle';
            const colorClass = err ? 'text-red-400' : 'text-green-400';

            // Inject fresh HTML so Lucide can render it again
            iconContainer.innerHTML = `<i data-lucide="${iconName}" class="w-4 h-4 ${colorClass}"></i>`;

            // Refresh icons
            lucide.createIcons();

            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 2500);
        }

        // --- Toolbar Helpers ---
        window.insertFormat = function (type) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            const selected = text.substring(start, end);
            let insert = '';
            let offset = 0;
            switch (type) {
                case 'bold': insert = `**${selected || 'bold'}**`; offset = selected ? 0 : -2; break;
                case 'italic': insert = `*${selected || 'italic'}*`; offset = selected ? 0 : -1; break;
                case 'h1': insert = `# ${selected || 'Header'} `; break;
                case 'h2': insert = `## ${selected || 'Header'} `; break;
                case 'list-ul': insert = `- ${selected || 'item'}`; break;
                case 'quote': insert = `> ${selected || 'quote'}`; break;
                case 'code': insert = `\`\`\`\n${selected || 'code'}\n\`\`\``; offset = selected ? 0 : -4; break;
                case 'math': insert = `$$ \n${selected || 'x = y^2'}\n $$`; offset = selected ? 0 : -3; break;
                case 'mermaid': insert = `\`\`\`mermaid\ngraph TD\n    A[Start] --> B[End]\n\`\`\``; offset = 0; break;
                case 'table': insert = `\n| Col A | Col B |\n| :--- | :--- |\n| Val 1 | Val 2 |\n`; break;
                case 'image': insert = `![Alt](https://via.placeholder.com/600x300)`; break;
                case 'toc': generateTOC(); return;
            }
            editor.value = text.substring(0, start) + insert + text.substring(end);
            editor.focus();
            editor.selectionStart = editor.selectionEnd = start + insert.length + offset;
            triggerSave();
            render();
        };

        window.hideImageCode = function () {
            const text = editor.value;
            const regex = /^\[([^\]]+)\]:\s*(data:image\/[^;\n]+;base64,[^\s]+)\s*$/gm;
            let count = 0;
            const newText = text.replace(regex, (fullMatch, id, data) => {
                if (!imageCache[id]) {
                    imageCache[id] = data;
                    saveImageToCloud(id, data);
                }
                count++;
                return '';
            });
            if (count > 0) {
                editor.value = newText.trim();
                triggerSave();
                render();
                showToast(`Cleaned ${count} images`);
            } else {
                showToast('No exposed code found', true);
            }
        };

        function generateTOC() {
            const lines = editor.value.split('\n');
            let toc = '## Table of Contents\n';
            lines.forEach(line => {
                const match = line.match(/^(#{1,3})\s+(.*)/);
                if (match) {
                    const level = match[1].length;
                    const slug = match[2].toLowerCase().replace(/[^\w]+/g, '-');
                    toc += `${'  '.repeat(level - 1)}- [${match[2]}](#${slug})\n`;
                }
            });
            const start = editor.selectionStart;
            editor.value = editor.value.substring(0, start) + toc + '\n' + editor.value.substring(start);
            triggerSave();
            render();
        }

        // Init
        lucide.createIcons();
        // FIX: Disabled htmlLabels to prevent Tainted Canvas error on export
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            flowchart: { htmlLabels: false },
            securityLevel: 'loose'
        });

        // Setup Resize Observer for pagination
        initPaginationObserver();

        editor.addEventListener('input', () => {
            triggerSave();
            clearTimeout(window.renderTimeout);
            window.renderTimeout = setTimeout(render, 300);
        });
        editor.addEventListener('keydown', (e) => {
            if (e.key == 'Tab') {
                e.preventDefault();
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                editor.value = editor.value.substring(0, start) + "\t" + editor.value.substring(end);
                editor.selectionStart = editor.selectionEnd = start + 1;
                triggerSave();
                render();
            }
        });

        // Drag and Drop (Toolbar)
        const editorPanel = document.getElementById('editor-panel');
        editorPanel.addEventListener('dragover', (e) => { e.preventDefault(); editorPanel.classList.add('drag-active'); });
        editorPanel.addEventListener('dragleave', (e) => { e.preventDefault(); editorPanel.classList.remove('drag-active'); });
        editorPanel.addEventListener('drop', (e) => {
            e.preventDefault();
            editorPanel.classList.remove('drag-active');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64 = event.target.result;
                    const id = 'img-' + Date.now();
                    imageCache[id] = base64;
                    saveImageToCloud(id, base64);
                    const insertRef = `![${file.name}][${id}]`;
                    const start = editor.selectionStart;
                    const end = editor.selectionEnd;
                    const text = editor.value;
                    editor.value = text.substring(0, start) + insertRef + text.substring(end);
                    triggerSave();
                    render();
                    showToast('Image Uploaded');
                };
                reader.readAsDataURL(file);
            }
        });

        // Initial application of settings (Defaults)
        applySettingsUI();
        updatePreviewStyles();

        initAuth();

    </script>
</body>

</html>