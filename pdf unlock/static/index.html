<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Unlocker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .drag-over {
            border-color: #ef4444;
            background-color: #fee2e2;
        }
        /* Custom scrollbar for a better look */
        #file-list-container::-webkit-scrollbar { 
            width: 8px; 
        }
        #file-list-container::-webkit-scrollbar-track { 
            background: #f1f5f9; 
        }
        #file-list-container::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 4px; 
        }
        #file-list-container::-webkit-scrollbar-thumb:hover { 
            background: #94a3b8; 
        }
        @keyframes spin { 
            to { 
                transform: rotate(360deg); 
            } 
        }
        .animate-spin-fast { 
            animation: spin 0.5s linear infinite; 
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-2xl flex flex-col md:flex-row min-h-[90vh] md:min-h-[80vh]">
    
        <div class="w-full md:w-2/3 bg-gray-50 flex flex-col relative rounded-b-2xl md:rounded-l-2xl md:rounded-br-none flex-grow" id="drop-area">            
            <div id="upload-prompt" class="w-full flex-grow flex flex-col items-center justify-center text-center p-4 sm:p-6">
                <svg class="mx-auto h-12 w-12 sm:h-16 sm:w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-base sm:text-lg font-semibold text-gray-800">Select PDF files</h3>
                <p class="mt-1 text-sm text-gray-500">or drag and drop them here</p>
                <div class="mt-4 sm:mt-6">
                    <input type="file" id="file-input" accept=".pdf" class="sr-only" multiple>
                    <label for="file-input" class="relative inline-flex items-center px-4 py-2 sm:px-6 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 cursor-pointer">
                        <span>Choose files</span>
                    </label>
                </div>
            </div>

            <div id="file-list-container" class="w-full flex-grow overflow-y-auto p-4 sm:p-6 pr-2 hidden">
                </div>
            
            <button id="add-more-files" class="hidden absolute bottom-4 right-4 sm:bottom-6 sm:right-6 bg-red-600 text-white rounded-full p-3 shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform hover:scale-110">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
            </button>
        </div>


        <div class="w-full md:w-1/3 p-4 sm:p-6 md:p-8 flex flex-col justify-between order-first md:order-none rounded-t-2xl md:rounded-r-2xl md:rounded-tl-none">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-900">PDF Unlocker</h1>
                <div id="info-box" class="mt-4 sm:mt-6 p-4 bg-blue-50 border-blue-200 text-blue-800 rounded-lg text-sm">
                    <p>Non-encrypted files are processed in your browser. Encrypted files are securely sent to our server for unlocking.</p>
                </div>
                <div id="results-box" class="hidden mt-4 sm:mt-6 p-4 border rounded-lg text-sm">
                    </div>
            </div>
            
            <div class="mt-6 sm:mt-8">
                <button id="process-btn" disabled class="w-full flex items-center justify-center bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed disabled:shadow-none transition-all duration-300">
                    <span id="button-text">Process PDF</span>
                    <svg id="button-arrow" class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    <svg id="loading-spinner" class="hidden animate-spin ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
                <a id="download-btn" class="hidden w-full mt-2 flex items-center justify-center bg-gray-800 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-gray-900 transition-all duration-300">
                    </a>
                <button id="start-over-btn" class="hidden w-full mt-3 text-sm text-gray-500 hover:text-red-600">Start Over</button>
            </div>
        </div>

    </div>

    <div id="password-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-900">Password Required</h3>
            <p class="text-sm text-gray-600 mt-2">The file "<span id="modal-file-name" class="font-semibold"></span>" is encrypted.</p>
            <div class="mt-4">
                <label for="password-input" class="block text-sm font-medium text-gray-700">Please enter the password:</label>
                <div class="relative mt-1">
                    <input type="password" id="password-input" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm pr-10">
                    <button type="button" id="toggle-password-visibility" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700 focus:outline-none">
                        <svg id="eye-icon-open" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <svg id="eye-icon-closed" class="h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7 9.542 7 .847 0 1.673.124 2.468.352M16.5 16.5l-12-12" />
                        </svg>
                    </button>
                </div>
                <p id="password-error" class="text-xs text-red-600 mt-1 hidden"></p>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-skip-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300">Skip</button>
                <button id="modal-unlock-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">Unlock</button>
            </div>
        </div>
    </div>

    <script>
        const { PDFDocument } = PDFLib;
        // DOM elements...
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const processBtn = document.getElementById('process-btn');
        const downloadBtn = document.getElementById('download-btn');
        const addMoreFilesBtn = document.getElementById('add-more-files');
        const startOverBtn = document.getElementById('start-over-btn');
        const buttonText = document.getElementById('button-text');
        const buttonArrow = document.getElementById('button-arrow');
        const loadingSpinner = document.getElementById('loading-spinner');
        const infoBox = document.getElementById('info-box');
        const resultsBox = document.getElementById('results-box');
        
        // Modal DOM elements
        const passwordModal = document.getElementById('password-modal');
        const modalFileName = document.getElementById('modal-file-name');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const modalSkipBtn = document.getElementById('modal-skip-btn');
        const modalUnlockBtn = document.getElementById('modal-unlock-btn');
        const togglePasswordVisibilityBtn = document.getElementById('toggle-password-visibility');
        const eyeIconOpen = document.getElementById('eye-icon-open');
        const eyeIconClosed = document.getElementById('eye-icon-closed');

        let selectedFiles = []; // { id, file, status: 'pending' | 'processing' | 'success' | 'failed', message? }

        // --- Drag and Drop Events ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}, false));
        ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false));
        ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false));
        dropArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files), false);

        // --- File Input & Handling ---
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        addMoreFilesBtn.addEventListener('click', () => fileInput.click());

        function handleFiles(files) {
            if (!files || files.length === 0) return;
            Array.from(files).forEach(file => {
                if (file.type === "application/pdf" && !selectedFiles.some(f => f.file.name === file.name)) {
                    selectedFiles.push({ id: Date.now() + Math.random(), file: file, status: 'pending' });
                }
            });
            renderUI();
        }

        function removeFile(fileId) {
            selectedFiles = selectedFiles.filter(f => f.id !== fileId);
            renderUI();
        }

        // --- UI Rendering ---
        function getStatusIcon(status) {
            switch(status) {
                case 'processing': return `<div class="w-5 h-5 animate-spin-fast border-2 border-blue-500 border-t-transparent rounded-full"></div>`;
                case 'success': return `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                case 'failed': return `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                default: return `<button class="text-gray-400 hover:text-red-600 flex-shrink-0" data-file-id="${status.id}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
            }
        }

        function renderUI() {
            const fileListContainer = document.getElementById('file-list-container');
            const uploadPrompt = document.getElementById('upload-prompt');
            
            // Clear the list from previous renders
            fileListContainer.innerHTML = ''; 

            if (selectedFiles.length === 0) {
                // Show the upload prompt and hide the file list
                uploadPrompt.classList.remove('hidden');
                fileListContainer.classList.add('hidden');
                
                // Update buttons and text
                addMoreFilesBtn.classList.add('hidden');
                processBtn.disabled = true;
                buttonText.textContent = 'Process PDF';
            } else {
                // Hide the upload prompt and show the file list
                uploadPrompt.classList.add('hidden');
                fileListContainer.classList.remove('hidden');

                const isProcessing = selectedFiles.some(f => f.status === 'processing');
                if (!isProcessing) {
                    addMoreFilesBtn.classList.remove('hidden');
                    processBtn.disabled = false;
                }
                buttonText.textContent = `Process ${selectedFiles.length} File(s)`;
                
                // Populate the file list container
                selectedFiles.forEach(fileObj => {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'bg-white p-3 mb-3 rounded-lg shadow-sm border border-gray-200 flex items-center justify-between';
                    fileElement.innerHTML = `
                        <div class="flex items-center overflow-hidden">
                            <svg class="h-8 w-8 text-red-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <div class="ml-3 overflow-hidden">
                                <p class="font-medium text-gray-800 text-sm truncate" title="${fileObj.file.name}">${fileObj.file.name}</p>
                                ${fileObj.message ? `<p class="text-xs text-gray-500">${fileObj.message}</p>` : ''}
                            </div>
                        </div>
                        <div class="status-icon ml-2 flex-shrink-0 w-5 h-5 flex items-center justify-center">
                            ${getStatusIcon(fileObj.status === 'pending' ? fileObj : fileObj.status)}
                        </div>`;
                    fileListContainer.appendChild(fileElement);
                    const removeBtn = fileElement.querySelector('button[data-file-id]');
                    if (removeBtn) {
                        removeBtn.addEventListener('click', (e) => removeFile(parseFloat(e.currentTarget.dataset.fileId)));
                    }
                });
            }
        }
        
        function resetState() {
            selectedFiles = [];
            fileInput.value = '';
            processBtn.classList.remove('hidden');
            downloadBtn.classList.add('hidden');
            downloadBtn.removeAttribute('href');
            downloadBtn.removeAttribute('download');
            startOverBtn.classList.add('hidden');
            infoBox.classList.remove('hidden');
            resultsBox.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            buttonArrow.classList.remove('hidden');
            renderUI();
        }

        startOverBtn.addEventListener('click', resetState);
        
        // --- Password Visibility Toggle ---
        togglePasswordVisibilityBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            eyeIconOpen.classList.toggle('hidden', isPassword);
            eyeIconClosed.classList.toggle('hidden', !isPassword);
        });

        // --- Password Modal Logic (MODIFIED) ---
        // This function now calls the server instead of using pdf-lib client-side.
        function promptForPassword(fileObj) {
            return new Promise((resolve) => {
                modalFileName.textContent = fileObj.file.name;
                // Reset modal
                passwordInput.value = '';
                passwordInput.type = 'password';
                eyeIconOpen.classList.remove('hidden');
                eyeIconClosed.classList.add('hidden');
                passwordError.classList.add('hidden');
                modalUnlockBtn.disabled = false;
                modalUnlockBtn.textContent = 'Unlock';
                modalSkipBtn.disabled = false;
                modalSkipBtn.textContent = 'Skip';

                passwordModal.classList.remove('hidden');
                passwordInput.focus();

                const onUnlock = async () => {
                    const password = passwordInput.value;
                    if (!password || modalUnlockBtn.disabled) return;

                    modalUnlockBtn.disabled = true;
                    modalSkipBtn.disabled = true;
                    modalUnlockBtn.textContent = 'Unlocking...';
                    passwordError.classList.add('hidden');

                    const formData = new FormData();
                    formData.append('file', fileObj.file);
                    formData.append('password', password);

                    try {
                        // Call the server endpoint
                        const resp = await fetch('/unlock', {
                            method: 'POST',
                            body: formData
                        });

                        if (!resp.ok) {
                            // Server rejected it (wrong password, bad file, etc.)
                            const err = await resp.json().catch(() => ({ message: "Server error" }));
                            passwordError.textContent = err.message || 'Failed to unlock PDF.';
                            passwordError.classList.remove('hidden');
                            modalUnlockBtn.disabled = false;
                            modalSkipBtn.disabled = false;
                            modalUnlockBtn.textContent = 'Unlock';
                            return; // Keep modal open for user to retry
                        }

                        // SUCCESS: Server sent back the unlocked file blob
                        const blob = await resp.blob();
                        const unlockedBytes = await blob.arrayBuffer();
                        // Resolve the promise with the new file bytes (as a Uint8Array)
                        cleanupAndResolve(new Uint8Array(unlockedBytes));

                    } catch (e) {
                        // Network error or server is down
                        console.error("Network error calling /unlock:", e);
                        passwordError.textContent = 'Error contacting server: ' + e.message;
                        passwordError.classList.remove('hidden');
                        modalUnlockBtn.disabled = false;
                        modalSkipBtn.disabled = false;
                        modalUnlockBtn.textContent = 'Unlock';
                    }
                };

                const onSkip = () => {
                    cleanupAndResolve(null);
                };

                const cleanupAndResolve = (result) => {
                    modalUnlockBtn.removeEventListener('click', onUnlock);
                    modalSkipBtn.removeEventListener('click', onSkip);
                    passwordInput.removeEventListener('keydown', onKeydown);
                    passwordModal.classList.add('hidden');
                    resolve(result); // result is either Uint8Array or null
                };
                
                const onKeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        onUnlock();
                    }
                };

                modalUnlockBtn.addEventListener('click', onUnlock);
                modalSkipBtn.addEventListener('click', onSkip);
                passwordInput.addEventListener('keydown', onKeydown);
            });
        }

        // --- Main Processing Logic (Unchanged, but see comments) ---
        processBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;

            buttonText.textContent = 'Processing...';
            loadingSpinner.classList.remove('hidden');
            buttonArrow.classList.add('hidden');
            processBtn.disabled = true;
            addMoreFilesBtn.classList.add('hidden');

            const processedFiles = []; // This will hold bytes from BOTH client and server unlocks

            for (const fileObj of selectedFiles) {
                fileObj.status = 'processing';
                renderUI();

                let unlockedBytes = null; // This will become a Uint8Array

                try {
                    const arrayBuffer = await fileObj.file.arrayBuffer();

                    let pdfDoc;
                    try {
                        // First try without password (client-side)
                        pdfDoc = await PDFDocument.load(arrayBuffer);
                        
                        // IF IT SUCCEEDS: It was not password-protected.
                        // We re-save it client-side to remove any *restrictions*.
                        const newPdfDoc = await PDFDocument.create();
                        const pageIndices = pdfDoc.getPageIndices();
                        const copiedPages = await newPdfDoc.copyPages(pdfDoc, pageIndices);
                        copiedPages.forEach(page => newPdfDoc.addPage(page));
                        unlockedBytes = await newPdfDoc.save(); // This is a Uint8Array
                        
                        fileObj.status = 'success';
                        fileObj.message = 'Processed (unencrypted)';

                    } catch (err) {
                        // IF IT FAILS: Assume it's encrypted.
                        // NOW we call our MODIFIED password prompt which calls the server.
                        unlockedBytes = await promptForPassword(fileObj); // Returns Uint8Array from server or null if skipped

                        if (unlockedBytes) {
                            fileObj.status = 'success';
                            fileObj.message = 'Unlocked via server';
                        } else {
                            fileObj.status = 'failed';
                            fileObj.message = 'Skipped or server unlock failed.';
                        }
                        renderUI();
                        
                        // Add to processed files list if server unlock was successful
                        if (unlockedBytes) {
                            processedFiles.push({ name: fileObj.file.name, bytes: unlockedBytes });
                        }
                        continue; // Go to the next file
                    }

                } catch (e) {
                    // This catches general errors, e.g., corrupt file
                    console.error("Error during PDF processing:", e);
                    fileObj.status = 'failed';
                    fileObj.message = 'Failed: Could not read file structure.';
                }
                
                // Add client-processed files to the list
                if (unlockedBytes) {
                    processedFiles.push({ name: fileObj.file.name, bytes: unlockedBytes });
                }

                renderUI();
            }

            // --- Finalize (Unchanged) ---
            // This part works perfectly as-is. It collects all successful byte arrays
            // (whether from the client-side processor or the server-side processor)
            // and zips them up.
            infoBox.classList.add('hidden');
            resultsBox.classList.remove('hidden');
            processBtn.classList.add('hidden');

            const successCount = processedFiles.length;
            const failedCount = selectedFiles.length - successCount;

            resultsBox.className = 'mt-6 p-4 border rounded-lg text-sm';
            if (successCount > 0) {
                 resultsBox.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
                 resultsBox.innerHTML = `<p class="font-semibold">Processing Complete!</p><p>${successCount} file(s) processed, ${failedCount} failed/skipped.</p>`;
            } else {
                 resultsBox.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                 resultsBox.innerHTML = `<p class="font-semibold">Processing Failed</p><p>Could not process any of the selected files.</p>`;
            }

            if (successCount > 0) {
                const zip = new JSZip();
                processedFiles.forEach(pf => zip.file(pf.name, pf.bytes));
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);

                downloadBtn.href = url;
                downloadBtn.download = 'processed_files.zip';
                downloadBtn.innerHTML = `Download ${successCount} Processed File(s)
                    <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>`;
                downloadBtn.classList.remove('hidden');
            }
            
            startOverBtn.classList.remove('hidden');
        });

        // The unused unlockPdf() function from your original file has been removed.
        
        renderUI();
    </script>

</body>
</html>