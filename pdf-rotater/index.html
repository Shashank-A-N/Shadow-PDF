<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Rotator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- pdf.js for rendering PDF previews -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <!-- pdf-lib.js for modifying and saving PDFs -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px;}
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px;}
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .file-item.selected {
            background-color: #e0f2fe; /* light blue */
            border-color: #0284c7; /* sky blue */
        }
        /* Custom styling for the select dropdown arrow */
        #zoom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.2rem center;
            padding-right: 1.5rem; /* Make space for the arrow */
        }
        .toast {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            transform: translateX(110%);
            opacity: 0;
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-700">PDF Rotator</h1>
            <p class="text-gray-500 mt-2">Rotate, preview, and download your PDFs—all in your browser.</p>
        </header>

        <main class="bg-white rounded-2xl shadow-lg flex flex-col md:flex-row overflow-hidden">
            <!-- Left Panel: File List and Preview -->
            <div class="w-full md:w-3/5 lg:w-2/3 border-r border-gray-200 flex flex-col" style="height: calc(100vh - 10rem); min-height: 500px;">
                <div id="file-upload-area" class="p-8 flex-grow flex flex-col items-center justify-center h-full">
                    <div class="text-center p-8 border-2 border-dashed border-gray-300 rounded-lg w-full max-w-lg">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7z" /></svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">Drag & drop your PDFs here</h3>
                        <p class="mt-1 text-sm text-gray-500">or</p>
                        <label for="fileInput" class="mt-2 cursor-pointer inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                            <span>Select Files</span>
                            <input id="fileInput" type="file" multiple accept=".pdf" class="sr-only">
                        </label>
                    </div>
                </div>

                <div id="file-display-area" class="hidden flex-grow flex flex-col h-full">
                     <!-- Files List -->
                    <div id="file-list-container" class="p-4 border-b border-gray-200 h-40 overflow-y-auto flex-shrink-0">
                        <div id="file-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                            <!-- File items will be injected here -->
                        </div>
                    </div>
                     <!-- PDF Preview -->
                    <div class="flex-grow bg-gray-50 relative">
                        <div id="pdf-preview-container" class="absolute inset-0 grid place-items-center p-4 overflow-auto">
                            <div id="preview-placeholder" class="text-center text-gray-500">
                               <p>Select a file to see a preview</p>
                            </div>
                             <canvas id="pdf-canvas" class="rounded-md shadow-md"></canvas>
                        </div>

                        <!-- Zoom Controls -->
                        <div id="zoom-controls" class="hidden absolute top-4 left-4 z-10 bg-gray-800 text-white px-3 py-1.5 rounded-full shadow-lg flex items-center gap-2 text-sm w-max">
                            <i data-lucide="zoom-in" class="w-4 h-4 text-gray-300"></i>
                            <select id="zoom-select" class="bg-transparent border-none focus:ring-0 p-0 text-white cursor-pointer">
                                <option value="fit-page" class="text-black">Fit Page</option>
                                <option value="fit-width" class="text-black">Fit Width</option>
                                <option value="50" class="text-black">50%</option>
                                <option value="75" class="text-black">75%</option>
                                <option value="100" class="text-black">100%</option>
                                <option value="125" class="text-black">125%</option>
                                <option value="150" class="text-black">150%</option>
                            </select>
                        </div>
                        
                        <!-- Page Navigation -->
                        <div id="page-nav" class="hidden absolute bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-4 text-sm z-10">
                            <button id="prev-page" class="hover:text-sky-300 disabled:opacity-50 disabled:cursor-not-allowed">&lt; Prev</button>
                            <span id="page-indicator">Page 1 / 1</span>
                            <button id="next-page" class="hover:text-sky-300 disabled:opacity-50 disabled:cursor-not-allowed">Next &gt;</button>
                        </div>

                        <!-- Centered Loader -->
                        <div id="loader" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20">
                            <svg class="animate-spin h-10 w-10 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Controls -->
            <div class="w-full md:w-2/5 lg:w-1/3 p-6 md:p-8 flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl font-semibold mb-2">Rotate PDF</h2>
                    <p class="text-gray-500 mb-6">Select a file from the list to apply rotations. Operations are applied to all pages.</p>
                    
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-medium">Rotation</h3>
                        <button id="reset-all-btn" class="text-sm text-sky-600 hover:underline">Reset all</button>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="rotate-right-btn" class="w-full flex items-center justify-center gap-3 py-3 px-4 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="rotate-cw" class="w-5 h-5 text-gray-600"></i>
                            <span class="font-medium">RIGHT</span>
                        </button>
                         <button id="rotate-left-btn" class="w-full flex items-center justify-center gap-3 py-3 px-4 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="rotate-ccw" class="w-5 h-5 text-gray-600"></i>
                            <span class="font-medium">LEFT</span>
                        </button>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="add-more-btn" class="w-full mb-3 flex items-center justify-center gap-2 py-3 px-4 rounded-lg bg-emerald-50 text-emerald-700 hover:bg-emerald-100 transition-colors hidden">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        <span>Add More PDFs</span>
                    </button>
                    <button id="process-btn" class="w-full flex items-center justify-center gap-3 py-4 px-4 rounded-lg bg-sky-600 text-white font-semibold hover:bg-sky-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span id="process-btn-text">Rotate PDFs</span>
                         <div id="process-loader" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                    <div id="download-container" class="mt-4 text-center"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast-container" class="fixed top-0 right-0 p-6 w-full max-w-sm z-50 space-y-3">
        <!-- Toasts will be injected here -->
    </div>

    <script>
        lucide.createIcons();

        // --- DOM Elements ---
        const fileInput = document.getElementById('fileInput');
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileDisplayArea = document.getElementById('file-display-area');
        const fileList = document.getElementById('file-list');
        const loader = document.getElementById('loader');
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        
        const rotateLeftBtn = document.getElementById('rotate-left-btn');
        const rotateRightBtn = document.getElementById('rotate-right-btn');
        const resetAllBtn = document.getElementById('reset-all-btn');
        const processBtn = document.getElementById('process-btn');
        const processBtnText = document.getElementById('process-btn-text');
        const processLoader = document.getElementById('process-loader');
        const downloadContainer = document.getElementById('download-container');
        const addMoreBtn = document.getElementById('add-more-btn');

        const pageNav = document.getElementById('page-nav');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageIndicator = document.getElementById('page-indicator');

        const zoomControls = document.getElementById('zoom-controls');
        const zoomSelect = document.getElementById('zoom-select');

        // --- State Management ---
        let filesData = []; // Array to store { id, file, rotation }
        let selectedFileId = null;
        let pdfDoc = null;
        let currentPage = 1;
        let currentScale = 'fit-page'; // 'fit-page', 'fit-width', or a percentage value

        // --- PDF.js Setup ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFiles);
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileUploadArea.addEventListener(eventName, preventDefaults, false);
        });
        fileUploadArea.addEventListener('drop', handleDrop, false);

        rotateLeftBtn.addEventListener('click', () => applyRotation(-90));
        rotateRightBtn.addEventListener('click', () => applyRotation(90));
        resetAllBtn.addEventListener('click', resetAllRotations);
        processBtn.addEventListener('click', processAndDownload);
        
        addMoreBtn.addEventListener('click', () => fileInput.click());
        
        prevPageBtn.addEventListener('click', showPrevPage);
        nextPageBtn.addEventListener('click', showNextPage);

        zoomSelect.addEventListener('change', (e) => {
            currentScale = e.target.value;
            if (selectedFileId) {
                renderPdfPage(selectedFileId, currentPage);
            }
        });

        // --- Functions ---
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            let dt = e.dataTransfer;
            let files = [...dt.files].filter(f => f.type === 'application/pdf');
            if(files.length > 0) {
                handleFiles({ target: { files } });
            }
        }

        function handleFiles(e) {
            const newFiles = Array.from(e.target.files);
            newFiles.forEach(file => {
                if (!filesData.some(f => f.file.name === file.name && f.file.size === file.size)) {
                     const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                     filesData.push({ id, file, rotation: 0 });
                }
            });
            if (filesData.length > 0 && !selectedFileId) {
                selectFile(filesData[0].id);
            }
            updateUI();
        }

        function updateUI() {
            if (filesData.length > 0) {
                fileUploadArea.style.display = 'none'; // Use style to preserve layout space
                fileDisplayArea.classList.remove('hidden');
                fileDisplayArea.classList.add('flex');
                addMoreBtn.classList.remove('hidden');
                processBtn.disabled = false;
            } else {
                fileUploadArea.style.display = 'flex';
                fileDisplayArea.classList.add('hidden');
                addMoreBtn.classList.add('hidden');
                processBtn.disabled = true;
                rotateLeftBtn.disabled = true;
                rotateRightBtn.disabled = true;
            }
            renderFileList();
            if (selectedFileId && !filesData.some(f => f.id === selectedFileId)) {
                clearPreview();
            }
        }
        
        function renderFileList() {
            fileList.innerHTML = '';
            filesData.forEach(fileData => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item border rounded-lg p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50';
                fileItem.dataset.id = fileData.id;
                if(fileData.id === selectedFileId) {
                    fileItem.classList.add('selected', 'border-sky-500');
                }

                const fileName = document.createElement('span');
                fileName.className = 'text-sm font-medium truncate';
                fileName.textContent = fileData.file.name;
                
                const fileControls = document.createElement('div');
                fileControls.className = 'flex items-center gap-2';

                const rotationBadge = document.createElement('span');
                rotationBadge.className = 'text-xs font-bold text-sky-700 bg-sky-100 px-2 py-1 rounded-full';
                rotationBadge.textContent = `${fileData.rotation}°`;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100';
                deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';

                fileItem.addEventListener('click', () => selectFile(fileData.id));
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteFile(fileData.id);
                });
                
                fileControls.appendChild(rotationBadge);
                fileControls.appendChild(deleteBtn);
                fileItem.appendChild(fileName);
                fileItem.appendChild(fileControls);
                fileList.appendChild(fileItem);
            });
            lucide.createIcons();
        }

        function selectFile(id) {
            if (selectedFileId === id) return;
            selectedFileId = id;
            pdfDoc = null; // Force reload for the new file
            rotateLeftBtn.disabled = false;
            rotateRightBtn.disabled = false;
            renderFileList();
            renderPdfPage(id, 1);
        }

        function deleteFile(id) {
            const wasSelected = selectedFileId === id;
            filesData = filesData.filter(f => f.id !== id);
            
            if (wasSelected) {
                 clearPreview();
                 if (filesData.length > 0) {
                     selectFile(filesData[0].id);
                 }
            }
            updateUI();
        }

        function clearPreview() {
            selectedFileId = null;
            pdfDoc = null;
            canvas.style.display = 'none';
            previewPlaceholder.style.display = 'block';
            pageNav.classList.add('hidden');
            zoomControls.classList.add('hidden');
            rotateLeftBtn.disabled = true;
            rotateRightBtn.disabled = true;
        }

        async function renderPdfPage(fileId, pageNum) {
            const fileData = filesData.find(f => f.id === fileId);
            if (!fileData) return;
            
            currentPage = pageNum;
            loader.classList.remove('hidden');
            canvas.style.display = 'none';
            previewPlaceholder.style.display = 'none';
            
            try {
                if (!pdfDoc) {
                     const fileReader = new FileReader();
                     fileReader.onload = async (e) => {
                         const typedarray = new Uint8Array(e.target.result);
                         pdfDoc = await pdfjsLib.getDocument({ data: typedarray }).promise;
                         displayPage(fileData, pageNum);
                     };
                     fileReader.readAsArrayBuffer(fileData.file);
                } else {
                     displayPage(fileData, pageNum);
                }

            } catch (error) {
                console.error('Error rendering PDF:', error);
                loader.classList.add('hidden');
                previewPlaceholder.textContent = 'Error loading preview.';
                previewPlaceholder.style.display = 'block';
            }
        }
        
        async function displayPage(fileData, pageNum) {
            const page = await pdfDoc.getPage(pageNum);
            const previewContainer = document.getElementById('pdf-preview-container');

            const totalRotation = (page.rotate + fileData.rotation) % 360;
            
            let scale;
            const unscaledViewport = page.getViewport({ scale: 1, rotation: totalRotation });
            const containerWidth = previewContainer.clientWidth - 32; // Subtract padding
            const containerHeight = previewContainer.clientHeight - 32;

            switch (currentScale) {
                case 'fit-width':
                    scale = containerWidth / unscaledViewport.width;
                    break;
                case 'fit-page':
                    scale = Math.min(containerWidth / unscaledViewport.width, containerHeight / unscaledViewport.height);
                    break;
                default: // Percentage
                    scale = parseFloat(currentScale) / 100;
                    break;
            }

            const viewport = page.getViewport({ scale, rotation: totalRotation });
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };
            await page.render(renderContext).promise;
            
            loader.classList.add('hidden');
            canvas.style.display = 'block';
            
            // Update page navigation and zoom
            pageIndicator.textContent = `Page ${pageNum} / ${pdfDoc.numPages}`;
            prevPageBtn.disabled = pageNum <= 1;
            nextPageBtn.disabled = pageNum >= pdfDoc.numPages;
            pageNav.classList.remove('hidden');
            zoomControls.classList.remove('hidden');
        }
        
        function showPrevPage() {
            if (currentPage <= 1) return;
            currentPage--;
            renderPdfPage(selectedFileId, currentPage);
        }

        function showNextPage() {
            if (currentPage >= pdfDoc.numPages) return;
            currentPage++;
            renderPdfPage(selectedFileId, currentPage);
        }

        function applyRotation(angle) {
            if (!selectedFileId) return;
            const fileData = filesData.find(f => f.id === selectedFileId);
            if (fileData) {
                fileData.rotation = (fileData.rotation + angle + 360) % 360; // Keep it positive
                renderFileList();
                renderPdfPage(selectedFileId, currentPage);
            }
        }
        
        function resetAllRotations() {
            filesData.forEach(f => f.rotation = 0);
            if (selectedFileId) {
                renderPdfPage(selectedFileId, currentPage);
            }
            renderFileList();
        }

        async function processAndDownload() {
            if (filesData.length === 0) return;

            processBtn.disabled = true;
            processBtnText.classList.add('hidden');
            processLoader.classList.remove('hidden');
            downloadContainer.innerHTML = ''; // Clear previous links/messages
            
            try {
                const { PDFDocument, degrees } = PDFLib;

                for(const fileData of filesData) {
                    let fileToDownload = fileData.file;
                    let finalFileName = fileData.file.name;

                    // Only process files that actually have a rotation applied
                    if (fileData.rotation !== 0) {
                        const existingPdfBytes = await fileData.file.arrayBuffer();
                        const pdfDoc = await PDFDocument.load(existingPdfBytes);
                        const pages = pdfDoc.getPages();
                        
                        pages.forEach(page => {
                            const currentRotation = page.getRotation().angle;
                            page.setRotation(degrees(currentRotation + fileData.rotation));
                        });
                        
                        const pdfBytes = await pdfDoc.save();
                        
                        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                        // Update the file in our state with the new rotated version
                        fileToDownload = new File([blob], fileData.file.name, { type: 'application/pdf' });
                        fileData.file = fileToDownload;
                        finalFileName = `rotated-${fileData.file.name}`;
                        fileData.rotation = 0; 
                    }
                    
                    // Create a download link for every file (rotated or not)
                    createDownloadLink(fileToDownload, finalFileName);
                }

                showToast('PDFs processed successfully!');

            } catch (error) {
                console.error('Failed to process PDFs:', error);
                showToast('An error occurred during processing.', 'error');
            } finally {
                processBtn.disabled = false;
                processBtnText.classList.remove('hidden');
                processLoader.classList.add('hidden');
                renderFileList(); // Re-render to show rotations reset to 0
                 if (selectedFileId) {
                    pdfDoc = null; // Force reload of the selected file to show its processed state
                    renderPdfPage(selectedFileId, currentPage);
                }
            }
        }
        
        function createDownloadLink(file, fileName) {
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.textContent = `Download ${fileName}`;
            a.className = "block w-full text-center mt-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium";
            
            // Note: We don't revoke the object URL so the link remains valid
            downloadContainer.appendChild(a);
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            
            const baseClasses = 'toast w-full max-w-xs p-4 rounded-lg shadow-lg text-white flex items-center gap-3';
            const typeClasses = type === 'success' 
                ? 'bg-green-500' 
                : 'bg-red-500';

            toast.className = `${baseClasses} ${typeClasses}`;

            const icon = type === 'success' 
                ? '<i data-lucide="check-circle" class="w-6 h-6"></i>'
                : '<i data-lucide="alert-circle" class="w-6 h-6"></i>';

            toast.innerHTML = `${icon}<span>${message}</span>`;
            
            container.appendChild(toast);
            lucide.createIcons();

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Set timeout to animate out and remove
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

    </script>
</body>
</html>

