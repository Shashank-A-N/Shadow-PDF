<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual PDF Splitter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library scripts will be loaded dynamically by the main script -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .page-card {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .page-card.removed {
            opacity: 0.4;
            transform: scale(0.95);
        }
        .split-button {
            transition: all 0.2s ease-in-out;
        }
        .split-button.active {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        #page-preview-container, #output-container, #loading, #error-message, #success-modal {
            display: none; /* Hidden by default */
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <!-- Header -->
        <div class="text-center mb-8 bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-4xl font-bold text-gray-800">Visual PDF Splitter</h1>
            <p class="text-gray-500 mt-2">Upload a PDF to see its pages. Remove pages or insert splits, then download your new files.</p>
        </div>

        <!-- Main UI Container -->
        <div id="app-container" class="bg-white rounded-xl shadow-2xl p-8 w-full">
            
            <!-- Error Message -->
            <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>

            <!-- Upload Section -->
            <div id="upload-section" style="display: block;">
                <label for="pdf-upload" class="w-full flex justify-center items-center px-6 py-10 bg-indigo-50 border-2 border-dashed border-indigo-200 text-indigo-600 rounded-lg cursor-pointer hover:bg-indigo-100 transition-colors">
                    <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                        <span class="mt-2 block font-semibold">Click to select a PDF file</span>
                        <span class="mt-1 block text-sm text-gray-500">Your file remains on your device</span>
                    </div>
                </label>
                <input id="pdf-upload" type="file" class="hidden" accept="application/pdf">
            </div>

            <!-- Loading Indicator -->
            <div id="loading" class="text-center my-4">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600"></div>
                <p class="text-gray-600 mt-4 text-lg" id="loading-text">Analyzing and rendering your PDF...</p>
            </div>

            <!-- Page Preview & Controls -->
            <div id="page-preview-container">
                <!-- Action Buttons -->
                <div id="controls" class="flex flex-wrap gap-4 items-center justify-center mb-8 p-4 bg-gray-50 rounded-lg border">
                    <button id="download-zip-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                        Download All (ZIP)
                    </button>
                    <button id="process-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105">
                        Get Individual Links
                    </button>
                    <button id="reset-selections-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        Reset Selections
                    </button>
                    <button id="start-over-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        Start Over
                    </button>
                </div>

                <!-- Download Links Section (MOVED) -->
                <div id="output-container" class="mb-8">
                     <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Your Split Files</h2>
                     <div id="download-links" class="flex flex-wrap justify-center gap-4 p-4 bg-gray-50 rounded-lg">
                        <!-- Download links will be injected here -->
                    </div>
                </div>
                
                <!-- Page Cards Grid -->
                <div id="page-grid" class="flex flex-wrap items-start justify-center gap-x-2 gap-y-8">
                    <!-- Page cards will be injected here -->
                </div>
            </div>
            
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Files Ready!</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Your new PDF(s) have been generated and are ready for download.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-button" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
                        View Downloads
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`Failed to load script: ${url}`));
                document.head.appendChild(script);
            });
        }

        function initializeApp() {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://unpkg.com/pdfjs-dist@2.14.305/build/pdf.worker.min.js`;

            const pdfUpload = document.getElementById('pdf-upload');
            const uploadSection = document.getElementById('upload-section');
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            const pagePreviewContainer = document.getElementById('page-preview-container');
            const pageGrid = document.getElementById('page-grid');
            const processButton = document.getElementById('process-button');
            const downloadZipButton = document.getElementById('download-zip-button');
            const resetSelectionsButton = document.getElementById('reset-selections-button');
            const startOverButton = document.getElementById('start-over-button');
            const outputContainer = document.getElementById('output-container');
            const downloadLinks = document.getElementById('download-links');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const successModal = document.getElementById('success-modal');
            const closeModalButton = document.getElementById('close-modal-button');

            let originalPdfBytes = null;
            let originalFileName = '';
            let pdfDoc = null; 
            let totalPages = 0;

            const { PDFDocument } = PDFLib;

            function showUI(element) { element.style.display = 'block'; }
            function hideUI(element) { element.style.display = 'none'; }
            function displayError(message) {
                console.error("Displaying Error:", message);
                errorText.textContent = message;
                showUI(errorMessage);
            }

            closeModalButton.addEventListener('click', () => hideUI(successModal));

            pdfUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file || file.type !== 'application/pdf') {
                    if(file) displayError("Invalid file type. Please select a PDF.");
                    return;
                }
                
                originalFileName = file.name.replace('.pdf', '');
                fullReset();
                hideUI(uploadSection);
                loadingText.textContent = 'Analyzing and rendering your PDF...';
                showUI(loading);

                const fileReader = new FileReader();
                
                fileReader.onload = async function() {
                    try {
                        originalPdfBytes = new Uint8Array(this.result);
                        const loadingTask = pdfjsLib.getDocument({ data: originalPdfBytes });
                        pdfDoc = await loadingTask.promise;
                        totalPages = pdfDoc.numPages;
                        
                        await renderAllPages();
                        
                        hideUI(loading);
                        showUI(pagePreviewContainer);
                    } catch (err) {
                        console.error("Error processing PDF data:", err);
                        displayError("Could not process the PDF. It might be corrupted, password-protected, or in an unsupported format.");
                        hideUI(loading);
                        showUI(uploadSection);
                    }
                };
                fileReader.onerror = function() {
                    console.error("FileReader error.");
                    displayError("There was an error reading the selected file.");
                    hideUI(loading);
                    showUI(uploadSection);
                };
                fileReader.readAsArrayBuffer(file);
            });

            async function renderAllPages() {
                pageGrid.innerHTML = '';
                for (let i = 1; i <= totalPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 0.25 });

                    const cardContainer = document.createElement('div');
                    cardContainer.className = 'flex items-start';
                    cardContainer.dataset.pageNumber = i;

                    const pageCard = document.createElement('div');
                    pageCard.className = 'page-card relative w-40 bg-white rounded-lg shadow-md p-1 border-gray-200';
                    
                    const canvas = document.createElement('canvas');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    canvas.className = 'rounded-md';

                    const pageLabel = document.createElement('span');
                    pageLabel.className = 'absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs font-bold px-1.5 py-0.5 rounded';
                    pageLabel.textContent = i;

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-6 w-6 flex items-center justify-center shadow-lg hover:bg-red-700 transition-transform transform hover:scale-110';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.title = `Remove page ${i}`;
                    removeBtn.onclick = () => pageCard.classList.toggle('removed');
                    
                    pageCard.append(canvas, pageLabel, removeBtn);

                    const splitBtn = document.createElement('button');
                    splitBtn.className = 'split-button self-center ml-2 bg-gray-200 rounded-full h-10 w-10 flex items-center justify-center text-gray-600 hover:bg-gray-300';
                    splitBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121M12 12l2.879-2.879M12 12L9.121 15.879M4 4l5.121 5.121" /></svg>`;
                    splitBtn.title = `Insert split after page ${i}`;
                    splitBtn.onclick = () => splitBtn.classList.toggle('active');

                    cardContainer.append(pageCard, splitBtn);
                    pageGrid.appendChild(cardContainer);

                    await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                }
            }
            
            function getPdfChunks() {
                const chunks = [];
                let currentChunk = [];
                const pageElements = pageGrid.querySelectorAll('[data-page-number]');

                for (const pageEl of pageElements) {
                    const pageNum = parseInt(pageEl.dataset.pageNumber);
                    const card = pageEl.querySelector('.page-card');
                    const splitBtn = pageEl.querySelector('.split-button');
                    
                    if (!card.classList.contains('removed')) {
                        currentChunk.push(pageNum - 1);
                    }

                    if (splitBtn && splitBtn.classList.contains('active')) {
                        if (currentChunk.length > 0) {
                            chunks.push(currentChunk);
                        }
                        currentChunk = [];
                    }
                }

                if (currentChunk.length > 0) {
                    chunks.push(currentChunk);
                }
                return chunks;
            }
            
            function setControlsDisabled(disabled) {
                processButton.disabled = disabled;
                downloadZipButton.disabled = disabled;
                resetSelectionsButton.disabled = disabled;
                startOverButton.disabled = disabled;
            }

            async function processAndGenerate(isZip) {
                if (!originalPdfBytes) return false;

                const chunks = getPdfChunks();
                if (chunks.length === 0 || chunks.every(c => c.length === 0)) {
                    displayError("No pages were selected to create a file.");
                    return false;
                }

                const loadedPdf = await PDFDocument.load(originalPdfBytes);
                
                if (isZip) {
                    const zip = new JSZip();
                    for (let i = 0; i < chunks.length; i++) {
                        const chunk = chunks[i];
                        if (chunk.length === 0) continue;
                        const newPdf = await PDFDocument.create();
                        const copiedPages = await newPdf.copyPages(loadedPdf, chunk);
                        copiedPages.forEach(page => newPdf.addPage(page));
                        const pdfBytes = await newPdf.save();
                        const fileName = chunks.length > 1 ? `${originalFileName}_part_${i + 1}.pdf` : `${originalFileName}_processed.pdf`;
                        zip.file(fileName, pdfBytes);
                    }
                    const zipBlob = await zip.generateAsync({ type: 'blob' });
                    createDownloadLink(zipBlob, `${originalFileName}_split.zip`);
                } else {
                    let generatedFileCount = 0;
                    for (let i = 0; i < chunks.length; i++) {
                        const chunk = chunks[i];
                        if (chunk.length === 0) continue;
                        const newPdf = await PDFDocument.create();
                        const copiedPages = await newPdf.copyPages(loadedPdf, chunk);
                        copiedPages.forEach(page => newPdf.addPage(page));
                        const pdfBytes = await newPdf.save();
                        const fileName = chunks.length > 1 ? `${originalFileName}_part_${i + 1}.pdf` : `${originalFileName}_processed.pdf`;
                        createDownloadLink(pdfBytes, fileName);
                        generatedFileCount++;
                    }
                    if (generatedFileCount === 0) {
                        displayError("No files were generated.");
                        return false;
                    }
                }
                return true;
            }

            processButton.addEventListener('click', async () => {
                if (processButton.disabled) return;
                setControlsDisabled(true);
                processButton.textContent = 'Processing...';
                hideUI(outputContainer);
                hideUI(errorMessage);
                downloadLinks.innerHTML = '';

                try {
                    const success = await processAndGenerate(false);
                    if (success) {
                        showUI(outputContainer);
                        showUI(successModal);
                    }
                } catch (err) {
                    console.error("Error during PDF processing:", err);
                    displayError("An unexpected error occurred during processing.");
                } finally {
                    setControlsDisabled(false);
                    processButton.textContent = 'Get Individual Links';
                }
            });

            downloadZipButton.addEventListener('click', async () => {
                if (downloadZipButton.disabled) return;
                setControlsDisabled(true);
                downloadZipButton.textContent = 'Zipping...';
                hideUI(outputContainer);
                hideUI(errorMessage);
                downloadLinks.innerHTML = '';

                try {
                    const success = await processAndGenerate(true);
                     if (success) {
                        showUI(outputContainer);
                        showUI(successModal);
                    }
                } catch (err) {
                    console.error("Error during ZIP creation:", err);
                    displayError("An unexpected error occurred while creating the ZIP file.");
                } finally {
                    setControlsDisabled(false);
                    downloadZipButton.textContent = 'Download All (ZIP)';
                }
            });

            function resetSelections() {
                if (processButton.disabled) return;
                hideUI(errorMessage);
                hideUI(outputContainer);
                pageGrid.querySelectorAll('.page-card.removed').forEach(card => card.classList.remove('removed'));
                pageGrid.querySelectorAll('.split-button.active').forEach(btn => btn.classList.remove('active'));
            }
            resetSelectionsButton.addEventListener('click', resetSelections);

            function fullReset() {
                originalPdfBytes = null;
                pdfDoc = null;
                totalPages = 0;
                pageGrid.innerHTML = '';
                downloadLinks.innerHTML = '';
                hideUI(pagePreviewContainer);
                hideUI(outputContainer);
                hideUI(loading);
                hideUI(errorMessage);
                hideUI(successModal);
            }
            startOverButton.addEventListener('click', () => {
                if (processButton.disabled) return;
                pdfUpload.value = '';
                fullReset();
                showUI(uploadSection);
            });

            function createDownloadLink(fileData, fileName) {
                const blob = (fileData instanceof Blob) ? fileData : new Blob([fileData], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.className = 'flex flex-col items-center text-center p-4 border rounded-lg hover:bg-gray-100 bg-white shadow-sm';
                const icon = fileName.endsWith('.zip') 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-yellow-500 mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 0v12h8V4H6zm3 4a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>`;
                link.innerHTML = `${icon}<span class="text-sm font-medium text-gray-700 break-all">${fileName}</span>`;
                downloadLinks.appendChild(link);
            }
        }

        Promise.all([
            loadScript('https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js'),
            loadScript('https://unpkg.com/pdfjs-dist@2.14.305/build/pdf.min.js'),
            loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js') // Add JSZip library
        ]).then(() => {
            initializeApp();
        }).catch(error => {
            console.error(error);
            document.body.innerHTML = `<div style="text-align: center; padding: 50px; font-family: sans-serif; color: red;"><h1>Error</h1><p>A required PDF library failed to load. Please check your internet connection, disable any ad-blockers that might interfere with scripts, and refresh the page.</p></div>`;
        });
    </script>
</body>
</html>
