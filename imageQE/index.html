<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano Banana AI Image Enhancer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0a09; /* A very dark base for the glass effect to pop */
            background-image: radial-gradient(circle at top right, rgba(139, 92, 246, 0.2), transparent 40%),
                              radial-gradient(circle at bottom left, rgba(20, 184, 166, 0.2), transparent 50%);
        }
        /* Custom scrollbar for a more integrated look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.2);
        }
        .fancy-loader {
            width: 48px;
            height: 48px;
            border: 5px solid rgba(255,255,255,0.2);
            border-bottom-color: #06b6d4; /* cyan-500 */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .processing-animation {
            background: linear-gradient(270deg, #d946ef, #8b5cf6, #06b6d4, #8b5cf6, #d946ef); /* fuchsia, purple, cyan */
            background-size: 400% 400%;
            animation: gradient-animation 3s ease infinite;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @media (min-width: 1024px) {
            .lg\:min-h-\[300px\] {
                min-height: 300px;
                width: 100%;
            }
        }
        .bg-black\/20 {
            background-color: rgb(37 55 61 / 20%);
        }
        option{
            background-color: #0c0a09; /* Match body background for dropdowns */
            /* border-radius: 12px; */
        }

    </style>
</head>
<body class="text-white min-h-screen flex flex-col items-center justify-center p-2 sm:p-4 lg:p-6 xl:p-8 font-sans selection:bg-fuchsia-500 selection:text-white">

    <div class="w-full max-w-6xl xl:max-w-7xl 2xl:max-w-screen-xl bg-black/20 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl p-4 sm:p-8 lg:p-12 space-y-8 sm:space-y-10 lg:space-y-12">
        <!-- Header Section -->
        <header class="text-center relative">
            <AI class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-500 via-purple-600 to-cyan-400">AI Image Enhancer and Modifier</h1>
            <p class="text-slate-400 mt-2 text-sm sm:text-base lg:text-lg">Upscale and modify images with the power of generative AI.</p>
            <button id="settings-btn" class="absolute top-0 right-0 p-2 text-slate-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>
        </header>

        <!-- Mode Toggles -->
        <div id="mode-toggles" class="flex justify-center items-center bg-black/20 backdrop-blur-md border border-white/10 p-1 rounded-full w-full max-w-xs mx-auto">
            <button id="toggle-enhance" class="w-1/2 py-2 px-4 rounded-full text-sm font-semibold transition-all duration-300">Enhance</button>
            <button id="toggle-modify" class="w-1/2 py-2 px-4 rounded-full text-sm font-semibold transition-all duration-300">Modify</button>
        </div>

        <!-- Error Message Display -->
        <div id="error-message" class="hidden bg-red-900/50 backdrop-blur-sm border border-red-500/50 text-red-300 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">Error:</strong>
            <span id="error-text" class="block sm:inline">Something went wrong.</span>
        </div>
        
        <!-- API Key Missing Message -->
        <div id="api-key-message" class="hidden bg-yellow-900/50 backdrop-blur-sm border border-yellow-500/50 text-yellow-300 px-4 py-3 rounded-lg" role="alert">
            <p><strong class="font-bold">API Key Needed:</strong> Please click the settings icon ⚙️ in the top right to enter your Google AI API key.</p>
        </div>

        <!-- Enhance Section Container -->
        <div id="enhance-section-container">
            <div class="space-y-6">
                <div class="text-center">
                     <h2 class="text-2xl sm:text-3xl lg:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-teal-300">1. Enhance Quality</h2>
                </div>
                <!-- Controls Section -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 lg:gap-8 items-center bg-black/20 backdrop-blur-md border border-white/10 p-3 sm:p-6 lg:p-8 rounded-xl">
                     <!-- File Upload & Camera -->
                    <div class="flex flex-col items-center justify-center">
                        <div class="w-full space-y-2">
                            <label for="image-upload" id="image-upload-label" class="cursor-pointer bg-white/5 hover:bg-white/10 border border-white/20 text-white font-bold py-3 px-4 sm:px-6 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105 w-full flex items-center justify-center space-x-2 text-sm sm:text-base">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 sm:w-5 sm:h-5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                                <span>Upload Image</span>
                            </label>
                            <button id="take-photo-btn" class="bg-white/5 hover:bg-white/10 border border-white/20 text-white font-bold py-3 px-4 sm:px-6 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-105 w-full flex items-center justify-center space-x-2 text-sm sm:text-base disabled:opacity-50 disabled:cursor-not-allowed">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 sm:w-5 sm:h-5"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                                <span>Take Photo</span>
                            </button>
                        </div>
                        <input id="image-upload" type="file" class="hidden" accept="image/png, image/jpeg, image/webp">
                        <p id="file-name" class="text-slate-500 text-xs sm:text-sm mt-2 truncate w-full text-center h-5"></p>
                    </div>
                    <!-- Quality Selection -->
                    <div class="flex flex-col w-full">
                        <label for="quality-select" class="text-sm font-medium text-slate-300 mb-2">Target Quality:</label>
                        <select id="quality-select" class="bg-black/20 border border-white/10 rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all w-full appearance-none text-center sm:text-left text-sm sm:text-base">
                            <option value="480p (Standard Definition)">480p (SD)</option>
                            <option value="720p (High Definition)">720p (HD)</option>
                            <option value="1080p (Full High Definition)" selected>1080p (FHD)</option>
                            <option value="4K (Ultra High Definition)">4K (UHD)</option>
                            <option value="8K (Cinema Quality)">8K (Cinema)</option>
                        </select>
                    </div>
                    <!-- Enhance Button -->
                    <button id="enhance-btn" disabled class="bg-slate-600 text-slate-400 font-bold py-3 px-4 sm:px-6 rounded-lg transition-all flex items-center justify-center space-x-2 h-full cursor-not-allowed text-sm sm:text-base">
                        <span>Enhance</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 sm:w-5 sm:h-5"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                    </button>
                </div>
                 <!-- Image Display Section -->
                <div id="image-display" class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-10 xl:gap-12 opacity-0 transition-opacity duration-700 ease-in-out">
                    <!-- Original Image -->
                    <div>
                        <h3 class="text-lg sm:text-xl lg:text-2xl font-semibold mb-4 text-center text-slate-300">Original</h3>
                        <div class="bg-black/20 border border-white/10 p-2 sm:p-4 rounded-lg aspect-video flex items-center justify-center min-h-[150px] sm:min-h-[200px] lg:min-h-[300px] xl:min-h-[400px]">
                            <img id="original-image" src="#" alt="Original Image" class="hidden max-w-full max-h-full object-contain rounded-md">
                            <p id="original-placeholder" class="text-slate-500 text-sm sm:text-base">Upload an image to begin</p>
                        </div>
                         <p id="original-dims" class="text-slate-500 text-xs sm:text-sm mt-2 text-center h-5"></p>
                    </div>
                    <!-- Enhanced Image -->
                    <div>
                        <h3 class="text-lg sm:text-xl lg:text-2xl font-semibold mb-4 text-center text-slate-300">Enhanced</h3>
                         <div id="enhanced-image-container" class="bg-black/20 border border-white/10 p-2 sm:p-4 rounded-lg aspect-video flex items-center justify-center relative min-h-[150px] sm:min-h-[200px] lg:min-h-[300px] xl:min-h-[400px]">
                            <img id="enhanced-image" src="#" alt="Enhanced Image" class="hidden max-w-full max-h-full object-contain rounded-md">
                            <div id="loader" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-black/50 backdrop-blur-sm rounded-lg">
                               <div class="fancy-loader"></div>
                               <p class="mt-4 text-slate-300 text-sm sm:text-base">AI is enhancing your image...</p>
                            </div>
                             <p id="enhanced-placeholder" class="text-slate-500 text-sm sm:text-base">Your enhanced image will appear here</p>
                        </div>
                        <p id="enhanced-dims" class="text-slate-500 text-xs sm:text-sm mt-2 text-center h-5"></p>
                    </div>
                </div>
                 <!-- Download Section -->
                <div id="download-section" class="hidden flex-col md:flex-row items-center justify-center gap-4 bg-black/20 backdrop-blur-md border border-white/10 p-3 sm:p-6 rounded-xl">
                    <label for="format-select" class="text-sm font-medium text-slate-300">Download as:</label>
                    <select id="format-select" class="bg-black/30 border border-white/10 rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition-all w-full md:w-auto text-sm sm:text-base">
                        <option value="png" selected>PNG</option>
                        <option value="jpeg">JPEG</option>
                        <option value="webp">WEBP</option>
                        <option value="pdf">PDF</option>
                    </select>
                    <button id="download-btn" class="bg-green-600/80 hover:bg-green-600 border border-green-500/50 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center space-x-2 w-full md:w-auto text-sm sm:text-base">
                        <span>Download Image</span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 sm:w-5 sm:h-5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                    </button>
                </div>
            </div>
            <hr class="border-white/10 my-8 sm:my-10 lg:my-12">
        </div>

        <!-- Modify with Text Section -->
        <div id="modify-section" class="space-y-6 sm:space-y-8 lg:space-y-10">
            <div class="text-center">
                <h2 class="text-2xl sm:text-3xl lg:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-fuchsia-500 via-purple-500 to-cyan-400">2. Modify Image with Text</h2>
                <p class="text-slate-400 mt-2 text-sm sm:text-base lg:text-lg">Use AI to edit your images with simple text commands.</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8 items-start bg-black/20 backdrop-blur-md border border-white/10 p-3 sm:p-6 lg:p-8 rounded-xl">
                <!-- 1. Source Image Column -->
                <div class="flex flex-col items-center justify-start space-y-4 h-full">
                    <h3 class="text-lg sm:text-xl font-semibold text-slate-300">1. Choose Image</h3>
                    <div id="modify-source-container" class="w-full bg-black/30 border border-white/10 p-2 rounded-lg aspect-video flex items-center justify-center">
                        <img id="modify-source-image" src="#" alt="Image to modify" class="hidden max-w-full max-h-full object-contain rounded-md">
                        <p id="modify-source-placeholder" class="text-slate-500 text-sm text-center">Select an image to modify</p>
                    </div>
                    <div class="w-full space-y-2">
                         <label for="modify-upload-input" id="modify-upload-label" class="cursor-pointer bg-cyan-600/50 hover:bg-cyan-600/80 border border-cyan-500/50 text-white font-bold py-2 px-4 rounded-lg transition-all w-full flex items-center justify-center space-x-2 text-sm">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                             <span>Upload New</span></label>
                        <input id="modify-upload-input" type="file" class="hidden" accept="image/png, image/jpeg, image/webp">
                         <button id="use-enhanced-btn" disabled class="disabled:cursor-not-allowed disabled:opacity-50 bg-indigo-600/50 hover:bg-indigo-600/80 border border-indigo-500/50 text-white font-bold py-2 px-4 rounded-lg transition-all w-full flex items-center justify-center space-x-2 text-sm">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>
                             <span>Use Enhanced Image</span></button>
                         <button id="modify-take-photo-btn" class="bg-purple-600/50 hover:bg-purple-600/80 border border-purple-500/50 text-white font-bold py-2 px-4 rounded-lg transition-all w-full flex items-center justify-center space-x-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                             <span>Take New Photo</span></button>
                    </div>
                </div>

                <!-- 2. Prompt Column -->
                <div class="flex flex-col items-center justify-start space-y-4 h-full">
                     <h3 class="text-lg sm:text-xl font-semibold text-slate-300">2. Describe Edit</h3>
                     <textarea id="modify-prompt" rows="6" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-slate-300 placeholder-slate-500 focus:ring-2 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition-all text-sm" placeholder="e.g., 'make the car red', 'add sunglasses to the cat', 'change background to a beach'"></textarea>
                     <button id="modify-btn" disabled class="disabled:cursor-not-allowed disabled:bg-slate-600 bg-fuchsia-600/80 hover:bg-fuchsia-600 border border-fuchsia-500/50 text-white font-bold py-3 px-4 rounded-lg transition-all w-full flex items-center justify-center space-x-2 text-base">
                         <span>Modify</span>
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                     </button>
                </div>

                <!-- 3. Result Column -->
                <div class="flex flex-col items-center justify-start space-y-4 h-full">
                     <h3 class="text-lg sm:text-xl font-semibold text-slate-300">3. View Result</h3>
                     <div id="modify-result-container" class="w-full bg-black/30 border border-white/10 p-2 rounded-lg aspect-video flex items-center justify-center relative">
                         <img id="modify-result-image" src="#" alt="Modified Image" class="hidden max-w-full max-h-full object-contain rounded-md">
                         <div id="modify-loader" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-black/50 backdrop-blur-sm rounded-lg">
                            <div class="fancy-loader"></div>
                            <p class="mt-4 text-slate-300 text-sm">AI is modifying your image...</p>
                        </div>
                         <p id="modify-result-placeholder" class="text-slate-500 text-sm">Your modified image appears here</p>
                     </div>
                     <button id="download-modified-btn" class="hidden bg-green-600/80 hover:bg-green-600 border border-green-500/50 text-white font-bold py-3 px-4 rounded-lg transition-all w-full flex items-center justify-center space-x-2 text-base">
                         <span>Download Modified</span>
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 sm:w-5 sm:h-5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                     </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-black/50 backdrop-blur-xl border border-white/10 rounded-xl shadow-lg w-full max-w-md p-6 space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-white">API Key Settings</h3>
                <button id="close-api-modal-btn" class="text-slate-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div>
                <label for="api-key-input" class="block text-sm font-medium text-slate-300 mb-2">Your Google AI API Key</label>
                <input type="password" id="api-key-input" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-slate-300 placeholder-slate-500 focus:ring-2 focus:ring-fuchsia-500 focus:border-fuchsia-500 transition-all" placeholder="Enter your API key here">
                <p class="text-xs text-slate-500 mt-2">Your key is saved only in your browser's local storage.</p>
            </div>
            <div class="flex justify-end space-x-4">
                <button id="save-api-key-btn" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Save Key</button>
            </div>
        </div>
    </div>


    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-2 sm:p-4">
        <div class="bg-black/50 backdrop-blur-xl border border-white/10 rounded-xl shadow-lg w-11/12 sm:w-10/12 md:w-8/12 lg:max-w-4xl xl:max-w-6xl p-4 sm:p-6 flex flex-col max-h-[95vh]">
            <!-- Header: Title and Close Button -->
            <div class="flex-shrink-0 flex items-center justify-between mb-4">
                <h3 class="text-base sm:text-lg font-medium leading-6 text-white">Live Camera</h3>
                <button id="close-camera-btn" class="text-slate-400 hover:text-white transition-colors" aria-label="Close camera">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <!-- Video Container -->
            <div class="flex-grow relative bg-black rounded-lg overflow-hidden flex justify-center items-center min-h-0 transition-all duration-300">
                <video id="camera-feed" class="w-full h-full object-contain" autoplay playsinline></video>
            </div>
            <!-- Capture Button container -->
            <div class="flex-shrink-0 flex items-center justify-center mt-4">
                <button id="capture-btn" class="bg-cyan-500/80 hover:bg-cyan-500 text-white font-bold p-3 sm:p-4 rounded-full transition-all transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 focus:ring-cyan-500" aria-label="Capture photo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 sm:w-6 sm:h-6"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                </button>
            </div>
        </div>
    </div>
    <canvas id="photo-canvas" class="hidden"></canvas> <!-- Hidden canvas for capturing -->

    <script>
        // --- DOM Element References ---
        // Toggles
        const toggleEnhanceBtn = document.getElementById('toggle-enhance');
        const toggleModifyBtn = document.getElementById('toggle-modify');
        const enhanceSectionContainer = document.getElementById('enhance-section-container');
        
        // API Key Modal
        const settingsBtn = document.getElementById('settings-btn');
        const apiKeyModal = document.getElementById('api-key-modal');
        const closeApiModalBtn = document.getElementById('close-api-modal-btn');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const apiKeyMessage = document.getElementById('api-key-message');

        // Enhance Section
        const imageUpload = document.getElementById('image-upload');
        const imageUploadLabel = document.getElementById('image-upload-label');
        const fileNameDisplay = document.getElementById('file-name');
        const qualitySelect = document.getElementById('quality-select');
        const enhanceBtn = document.getElementById('enhance-btn');
        const imageDisplay = document.getElementById('image-display');
        const originalImage = document.getElementById('original-image');
        const originalPlaceholder = document.getElementById('original-placeholder');
        const originalDims = document.getElementById('original-dims');
        const enhancedImage = document.getElementById('enhanced-image');
        const enhancedPlaceholder = document.getElementById('enhanced-placeholder');
        const enhancedDims = document.getElementById('enhanced-dims');
        const loader = document.getElementById('loader');
        const downloadSection = document.getElementById('download-section');
        const formatSelect = document.getElementById('format-select');
        const downloadBtn = document.getElementById('download-btn');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        // Modify Section
        const modifySection = document.getElementById('modify-section');
        const modifyUploadInput = document.getElementById('modify-upload-input');
        const modifyUploadLabel = document.getElementById('modify-upload-label');
        const useEnhancedBtn = document.getElementById('use-enhanced-btn');
        const modifyTakePhotoBtn = document.getElementById('modify-take-photo-btn');
        const modifySourceImage = document.getElementById('modify-source-image');
        const modifySourcePlaceholder = document.getElementById('modify-source-placeholder');
        const modifyPrompt = document.getElementById('modify-prompt');
        const modifyBtn = document.getElementById('modify-btn');
        const modifyResultImage = document.getElementById('modify-result-image');
        const modifyResultPlaceholder = document.getElementById('modify-result-placeholder');
        const modifyLoader = document.getElementById('modify-loader');
        const downloadModifiedBtn = document.getElementById('download-modified-btn');

        // Camera Modal
        const takePhotoButton = document.getElementById('take-photo-btn');
        const cameraModal = document.getElementById('camera-modal');
        const cameraFeed = document.getElementById('camera-feed');
        const captureBtn = document.getElementById('capture-btn');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const photoCanvas = document.getElementById('photo-canvas');

        // --- State variables ---
        let userApiKey = null;
        let originalImageData = null;
        let enhancedImageDataUrl = null;
        let modifySourceData = null;
        let modifyResultDataUrl = null;
        let cameraStream = null;
        let cameraTargetSection = null; // 'enhance' or 'modify'

        // --- Event Listeners ---
        
        // ### API Key Modal Listeners ###
        settingsBtn.addEventListener('click', () => {
            apiKeyInput.value = userApiKey || '';
            apiKeyModal.classList.remove('hidden');
            apiKeyModal.classList.add('flex');
        });
        
        closeApiModalBtn.addEventListener('click', () => {
            apiKeyModal.classList.add('hidden');
            apiKeyModal.classList.remove('flex');
        });

        saveApiKeyBtn.addEventListener('click', () => {
            const newKey = apiKeyInput.value.trim();
            if (newKey) {
                localStorage.setItem('userApiKey', newKey);
                userApiKey = newKey;
                apiKeyMessage.classList.add('hidden');
                console.log("API Key saved.");
            } else {
                localStorage.removeItem('userApiKey');
                userApiKey = null;
                console.log("API Key removed.");
            }
            apiKeyModal.classList.add('hidden');
            apiKeyModal.classList.remove('flex');
            checkApiKey();
        });


        // ### Toggle Listeners ###
        toggleEnhanceBtn.addEventListener('click', () => switchView('enhance'));
        toggleModifyBtn.addEventListener('click', () => switchView('modify'));

        // ### Enhance Section Listeners ###
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => handleImageSourceForEnhance(e.target.result, file.type, file.name);
                reader.readAsDataURL(file);
            }
        });

        takePhotoButton.addEventListener('click', () => openCamera('enhance'));
        
        enhanceBtn.addEventListener('click', handleEnhance);
        
        downloadBtn.addEventListener('click', () => {
            if (enhancedImageDataUrl) {
                downloadImage(enhancedImageDataUrl, `enhanced-${Date.now()}`);
            }
        });

        // ### Modify Section Listeners ###
        modifyUploadInput.addEventListener('change', (event) => {
             const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => handleImageSourceForModify(e.target.result, file.type);
                reader.readAsDataURL(file);
            }
        });

        useEnhancedBtn.addEventListener('click', () => {
            if (enhancedImageDataUrl) {
                // We need mime type, assume it's png from enhancement
                handleImageSourceForModify(enhancedImageDataUrl, 'image/png');
            }
        });

        modifyTakePhotoBtn.addEventListener('click', () => openCamera('modify'));

        modifyPrompt.addEventListener('input', checkModifyButtonState);
        
        modifyBtn.addEventListener('click', handleModify);

        downloadModifiedBtn.addEventListener('click', () => {
            if(modifyResultDataUrl) {
                downloadImage(modifyResultDataUrl, `modified-${Date.now()}`);
            }
        });

        // ### Camera Listeners ###
        closeCameraBtn.addEventListener('click', closeCamera);
        captureBtn.addEventListener('click', capturePhoto);

        // --- Core Logic Functions ---

        /**
         * Main handler for the "Enhance" button click.
         */
        async function handleEnhance() {
            if (!checkApiKey()) return;
            if (!originalImageData) return showError("Please upload an image first.");
            
            // Prepare UI for processing
            setProcessingState(enhanceBtn, 'Enhancing...', true);
            imageUpload.disabled = true;
            imageUploadLabel.classList.add('opacity-50', 'cursor-not-allowed');
            takePhotoButton.disabled = true;

            loader.classList.add('flex');
            loader.classList.remove('hidden');
            enhancedImage.classList.add('hidden');
            enhancedPlaceholder.classList.add('hidden');
            downloadSection.classList.add('hidden');
            enhancedDims.textContent = '';
            hideError();

            const targetQuality = qualitySelect.value;
            const originalWidth = originalImage.naturalWidth;

            const qualityMap = {
                '480p (Standard Definition)': 640,
                '720p (High Definition)': 1280,
                '1080p (Full High Definition)': 1920,
                '4K (Ultra High Definition)': 3840,
                '8K (Cinema Quality)': 7680
            };

            const targetWidth = qualityMap[targetQuality];
            let operationVerb = "Render";
            if (targetWidth > originalWidth) {
                operationVerb = "Upscale and render";
            } else if (targetWidth < originalWidth) {
                operationVerb = "Downscale and render";
            }


            const baseInstruction = "Execute a master-level photographic enhancement to match the target resolution. The goal is a pristine, high-fidelity, photorealistic image that is unequivocally superior to the original. Key enhancements include: 1. **Clarity & Detail:** Introduce fine, realistic micro-details and texture. Achieve sharp, well-defined edges without artificial halos. 2. **Lighting & Contrast:** Intelligently expand the dynamic range, recovering detail in highlights and shadows. Improve local contrast for a three-dimensional feel while maintaining a natural tonal curve. 3. **Color Science:** Optimize color vibrancy, accuracy, and harmony. Perform subtle color grading to enhance the mood without looking unnatural. Ensure skin tones are preserved and look lifelike. 4. **Noise & Artifacts:** Meticulously remove digital noise, compression artifacts, and any chromatic aberration or lens distortion. For 4K/8K, add a hint of fine, natural-looking film grain to avoid a sterile digital look. 5. **Composition:** The final image must not add, remove, or change any objects, characters, or the core composition of the original scene.";
            
            const qualityPrompts = {
                '480p (Standard Definition)': `${operationVerb} this image at a clean 480p resolution. Focus primarily on clarity and artifact removal, ensuring a sharp standard-definition output. ${baseInstruction}`,
                '720p (High Definition)': `${operationVerb} this image at a sharp 720p (HD) resolution. Balance the generation of new details with a natural, clean appearance suitable for high definition. ${baseInstruction}`,
                '1080p (Full High Definition)': `${operationVerb} this image to a crisp, high-quality 1080p (Full HD) resolution. Focus on generating convincing details for a sharp, clear result. ${baseInstruction}`,
                '4K (Ultra High Definition)': `${operationVerb} this image to a stunning, photorealistic 4K (Ultra HD) resolution. Generate fine, intricate details and textures suitable for a high-resolution display. ${baseInstruction}`,
                '8K (Cinema Quality)': `${operationVerb} this image to an incredible, cinema-quality 8K resolution. Generate hyper-realistic details, textures, and clarity. The final image must be of the absolute highest possible fidelity. ${baseInstruction}`
            };
            const prompt = qualityPrompts[targetQuality] || `${operationVerb} this image at a high-quality ${targetQuality} resolution. ${baseInstruction}`;

            try {
                const result = await callImageApi(prompt, originalImageData);
                enhancedImageDataUrl = `data:image/png;base64,${result}`;
                enhancedImage.src = enhancedImageDataUrl;
                enhancedImage.classList.remove('hidden');
                enhancedImage.onload = () => enhancedDims.textContent = `${enhancedImage.naturalWidth} x ${enhancedImage.naturalHeight}`;

                downloadSection.classList.remove('hidden');
                downloadSection.classList.add('flex');
                useEnhancedBtn.disabled = false;
            } catch (error) {
                console.error("Enhancement Error:", error);
                showError(error.message || "Failed to enhance the image.");
                enhancedPlaceholder.classList.remove('hidden');
                enhancedPlaceholder.textContent = 'Enhancement failed.';
            } finally {
                loader.classList.remove('flex');
                loader.classList.add('hidden');
                setProcessingState(enhanceBtn, 'Enhance', false);
                imageUpload.disabled = false;
                imageUploadLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                takePhotoButton.disabled = false;
            }
        }
        
        /**
         * Main handler for the "Modify" button click.
         */
        async function handleModify() {
            if (!checkApiKey()) return;
            const prompt = modifyPrompt.value.trim();
            if (!modifySourceData) return showError("Please select an image to modify.");
            if (!prompt) return showError("Please enter a text prompt to describe your edit.");
            
            setProcessingState(modifyBtn, 'Modifying...', true);
            modifyUploadInput.disabled = true;
            modifyUploadLabel.classList.add('opacity-50', 'cursor-not-allowed');
            useEnhancedBtn.disabled = true;
            modifyTakePhotoBtn.disabled = true;
            modifyPrompt.disabled = true;
            modifyLoader.classList.add('flex');
            modifyLoader.classList.remove('hidden');
            modifyResultImage.classList.add('hidden');
            modifyResultPlaceholder.classList.add('hidden');
            downloadModifiedBtn.classList.add('hidden');
            hideError();

            try {
                const result = await callImageApi(prompt, modifySourceData);
                modifyResultDataUrl = `data:image/png;base64,${result}`;
                modifyResultImage.src = modifyResultDataUrl;
                modifyResultImage.classList.remove('hidden');
                downloadModifiedBtn.classList.remove('hidden');

            } catch(error) {
                 console.error("Modification Error:", error);
                showError(error.message || "Failed to modify the image.");
                modifyResultPlaceholder.classList.remove('hidden');
                modifyResultPlaceholder.textContent = 'Modification failed.';
            } finally {
                modifyLoader.classList.remove('flex');
                modifyLoader.classList.add('hidden');
                setProcessingState(modifyBtn, 'Modify', false);
                modifyUploadInput.disabled = false;
                modifyUploadLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                if (enhancedImageDataUrl) {
                    useEnhancedBtn.disabled = false;
                }
                modifyTakePhotoBtn.disabled = false;
                modifyPrompt.disabled = false;
            }
        }

        // --- UI and State Management Functions ---

        /**
         * Switches between the 'Enhance' and 'Modify' views.
         * @param {string} view - The view to switch to ('enhance' or 'modify').
         */
        function switchView(view) {
            const activeClasses = ['bg-gradient-to-r', 'from-fuchsia-600', 'to-cyan-500', 'text-white'];
            const inactiveClasses = ['text-slate-400', 'hover:bg-white/5'];

            if (view === 'enhance') {
                enhanceSectionContainer.classList.remove('hidden');
                modifySection.classList.add('hidden');

                toggleEnhanceBtn.classList.add(...activeClasses);
                toggleEnhanceBtn.classList.remove(...inactiveClasses);

                toggleModifyBtn.classList.add(...inactiveClasses);
                toggleModifyBtn.classList.remove(...activeClasses);
            } else { // 'modify'
                enhanceSectionContainer.classList.add('hidden');
                modifySection.classList.remove('hidden');
                
                toggleEnhanceBtn.classList.add(...inactiveClasses);
                toggleEnhanceBtn.classList.remove(...activeClasses);

                toggleModifyBtn.classList.add(...activeClasses);
                toggleModifyBtn.classList.remove(...inactiveClasses);
            }
        }

        function handleImageSourceForEnhance(dataUrl, mimeType, name) {
            resetUIForNewUpload();
            fileNameDisplay.textContent = name;
            originalImageData = { dataUrl, mimeType };
            originalImage.src = dataUrl;
            originalImage.classList.remove('hidden');
            originalPlaceholder.classList.add('hidden');
            imageDisplay.classList.remove('opacity-0');
            originalImage.onload = () => originalDims.textContent = `${originalImage.naturalWidth} x ${originalImage.naturalHeight}`;
            
            enhanceBtn.disabled = false;
            enhanceBtn.classList.remove('bg-slate-600', 'text-slate-400', 'cursor-not-allowed');
            enhanceBtn.classList.add('bg-teal-500/50', 'hover:bg-teal-500/80', 'border', 'border-teal-500/50', 'text-white', 'cursor-pointer');
        }

        function handleImageSourceForModify(dataUrl, mimeType) {
            hideError();
            modifySourceData = { dataUrl, mimeType };
            modifySourceImage.src = dataUrl;
            modifySourceImage.classList.remove('hidden');
            modifySourcePlaceholder.classList.add('hidden');
            checkModifyButtonState();
        }

        function resetUIForNewUpload() {
            hideError();
            enhancedImage.classList.add('hidden');
            enhancedImage.src = "#";
            enhancedPlaceholder.classList.remove('hidden');
            enhancedPlaceholder.textContent = 'Your enhanced image will appear here';
            downloadSection.classList.add('hidden');
            originalImageData = null;
            enhancedImageDataUrl = null;
            originalDims.textContent = '';
            enhancedDims.textContent = '';
            useEnhancedBtn.disabled = true;
        }

        function checkModifyButtonState(){
            const prompt = modifyPrompt.value.trim();
            if (modifySourceData && prompt) {
                modifyBtn.disabled = false;
            } else {
                modifyBtn.disabled = true;
            }
        }

        function setProcessingState(button, text, isProcessing) {
            button.disabled = isProcessing;
            button.querySelector('span').textContent = text;
            if (isProcessing) {
                button.classList.add('processing-animation', 'cursor-wait');
            } else {
                button.classList.remove('processing-animation', 'cursor-wait');
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // --- Camera Functions ---

        async function openCamera(target) {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return showError("Camera access not supported.");
            
            cameraTargetSection = target;
            hideError();
            cameraModal.classList.add('flex');
            cameraModal.classList.remove('hidden');

            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                cameraFeed.srcObject = cameraStream;
                cameraFeed.addEventListener('loadedmetadata', () => {
                    if (cameraFeed.videoWidth > 0) {
                        cameraFeed.parentElement.style.aspectRatio = cameraFeed.videoWidth / cameraFeed.videoHeight;
                    }
                }, { once: true });
            } catch (err) {
                console.error("Camera Access Error:", err);
                showError("Could not access the camera. Please check permissions.");
                closeCamera();
            }
        }

        function closeCamera() {
            if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
            cameraFeed.srcObject = null;
            cameraStream = null;
            cameraModal.classList.add('hidden');
            cameraModal.classList.remove('flex');
            cameraFeed.parentElement.style.aspectRatio = '';
        }

        function capturePhoto() {
            if (!cameraStream) return showError("Camera is not active.");
            
            photoCanvas.width = cameraFeed.videoWidth;
            photoCanvas.height = cameraFeed.videoHeight;
            photoCanvas.getContext('2d').drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);
            const dataUrl = photoCanvas.toDataURL('image/jpeg');
            const filename = `capture-${Date.now()}.jpg`;

            if (cameraTargetSection === 'enhance') {
                handleImageSourceForEnhance(dataUrl, 'image/jpeg', filename);
            } else if (cameraTargetSection === 'modify') {
                handleImageSourceForModify(dataUrl, 'image/jpeg');
            }
            closeCamera();
        }

        // --- Utility and API Functions ---

        function downloadImage(dataUrl, baseFilename) {
            const format = formatSelect.value;
            const filename = `${baseFilename}.${format === 'pdf' ? 'pdf' : format}`;
            
            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const img = new Image();
                img.onload = () => {
                    const orientation = img.width > img.height ? 'l' : 'p';
                    const doc = new jsPDF({ orientation, unit: 'px', format: [img.width, img.height] });
                    doc.addImage(img, 'PNG', 0, 0, img.width, img.height);
                    doc.save(filename);
                };
                img.src = dataUrl;
                return;
            }

            const link = document.createElement('a');
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                if(format === 'jpeg') {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                ctx.drawImage(img, 0, 0);
                link.href = canvas.toDataURL(`image/${format}`, 0.95);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            img.src = dataUrl;
        }
        
        function checkApiKey() {
            if (!userApiKey) {
                apiKeyMessage.classList.remove('hidden');
                return false;
            }
            apiKeyMessage.classList.add('hidden');
            return true;
        }

        /**
         * Generic function to call the Gemini API for image generation/modification.
         * @param {string} userPrompt The text prompt for the AI.
         * @param {object} imageData The image data object { dataUrl, mimeType }.
         * @returns {Promise<string>} The base64 string of the generated image.
         */
        async function callImageApi(userPrompt, imageData) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${userApiKey}`;
            const base64Data = imageData.dataUrl.split(',')[1];
            const payload = {
                contents: [{ parts: [{ text: userPrompt }, { inlineData: { mimeType: imageData.mimeType, data: base64Data } }] }],
                generationConfig: { responseModalities: ['IMAGE'] },
            };

            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;

            while (attempts < maxAttempts) {
                let response;
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (networkError) {
                    // This catches actual network errors (e.g., no internet)
                    attempts++;
                    if (attempts >= maxAttempts) {
                        throw new Error("A network error occurred. Please check your connection.");
                    }
                    console.error(`Network error, retrying in ${delay}ms...`, networkError);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                    continue; // Continue to the next iteration of the loop
                }

                // If we get here, the fetch was successful. Now check the HTTP status.
                if (response.ok) {
                    const result = await response.json();
                    const b64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    if (!b64Data) {
                        throw new Error("No image data returned from API. The model may have refused the request.");
                    }
                    return b64Data; // Success!
                }

                // --- Handle HTTP errors ---

                // Errors we DON'T want to retry (fail fast)
                if (response.status === 429) {
                    throw new Error("Rate limit exceeded. Please wait a minute before trying again.");
                }
                if (response.status === 403) {
                    throw new Error("API Key is invalid or not correctly configured. Please check your key in the settings and ensure the Generative Language API is enabled in your project.");
                }
                
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.error?.message || `API request failed with status ${response.status}.`;
                
                if (errorMessage.toLowerCase().includes('quota') || errorMessage.toLowerCase().includes('billing')) {
                    throw new Error("Your project's free quota has been exceeded. Please enable billing in the Google Cloud Console for this project, or create a new project to get a new free quota.");
                }

                // For other errors (like 5xx server errors), we'll let the loop retry.
                attempts++;
                if (attempts >= maxAttempts) {
                    throw new Error(errorMessage); // Throw the last error if we're out of retries
                }
                console.error(`API error, retrying in ${delay}ms...`, {status: response.status, message: errorMessage});
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            userApiKey = localStorage.getItem('userApiKey');
            switchView('enhance');
            checkApiKey();
        });
    </script>
</body>
</html>

