<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch PDF Flattener</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PDF-Lib -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <!-- JSZip for batch download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        iframe {
            border: none;
        }

        /* Custom scrollbar for file list */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-blue-100 flex flex-col">

    <!-- Header -->
    <header
        class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm sticky top-0 z-20">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg text-white">
                <i data-lucide="layers" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800">Batch PDF Flattener</h1>
                <p class="text-xs text-slate-500 font-medium">Securely process multiple files</p>
            </div>
        </div>
        <div id="loading-indicator"
            class="hidden text-xs font-mono bg-amber-100 text-amber-800 px-2 py-1 rounded animate-pulse">
            Loading Libraries...
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-6 flex-grow w-full h-[calc(100vh-80px)] flex flex-col">

        <!-- Upload Section (Visible when no files) -->
        <div id="upload-section"
            class="flex-grow flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded-xl bg-white transition-all cursor-pointer group hover:border-blue-400 hover:bg-blue-50">
            <div class="text-center p-12">
                <div
                    class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="upload-cloud" class="w-10 h-10"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-700 mb-3">
                    Upload PDFs
                </h3>
                <p class="text-slate-500 text-base mb-8 max-w-md mx-auto">
                    Drag and drop multiple PDF files here, or click to browse.
                </p>
                <button id="browse-btn"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg text-sm font-semibold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all active:scale-95 pointer-events-none">
                    Select Files
                </button>
                <input type="file" id="file-input" accept=".pdf" multiple class="hidden" />
            </div>
        </div>

        <!-- Main Interface (Visible when files exist) -->
        <div id="main-interface" class="hidden flex-grow flex flex-col md:flex-row gap-6 h-full overflow-hidden">

            <!-- Sidebar: File List & Controls -->
            <div class="w-full md:w-96 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col h-full">

                <!-- Sidebar Header -->
                <div class="p-4 border-b border-slate-200 flex items-center justify-between bg-slate-50 rounded-t-xl">
                    <h2 class="font-semibold text-slate-700 flex items-center gap-2">
                        <i data-lucide="files" class="w-4 h-4"></i>
                        Files <span id="file-count"
                            class="bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-xs">0</span>
                    </h2>
                    <button id="add-more-btn"
                        class="text-blue-600 text-xs font-medium hover:underline flex items-center gap-1">
                        <i data-lucide="plus" class="w-3 h-3"></i> Add More
                    </button>
                </div>

                <!-- File List -->
                <ul id="file-list" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scroll bg-slate-50/50">
                    <!-- Items injected by JS -->
                </ul>

                <!-- Sidebar Footer: Actions -->
                <div class="p-4 border-t border-slate-200 bg-white rounded-b-xl space-y-3">
                    <div id="progress-container" class="hidden mb-2">
                        <div class="flex justify-between text-xs mb-1 text-slate-600">
                            <span>Processing...</span>
                            <span id="progress-text">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2">
                            <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                    </div>

                    <button id="process-all-btn"
                        class="w-full py-3 px-4 rounded-lg flex items-center justify-center gap-2 font-medium text-white shadow-lg transition-all bg-blue-600 hover:bg-blue-700 active:scale-[0.98]">
                        <i data-lucide="lock" class="w-4 h-4"></i> Flatten All
                    </button>

                    <div id="download-actions" class="hidden grid grid-cols-2 gap-2">
                        <button id="download-zip-btn"
                            class="col-span-2 py-2 px-4 rounded-lg flex items-center justify-center gap-2 font-medium text-white bg-green-600 hover:bg-green-700 shadow transition-all active:scale-[0.98]">
                            <i data-lucide="archive" class="w-4 h-4"></i> Download All (ZIP)
                        </button>
                    </div>

                    <button id="clear-all-btn"
                        class="w-full py-2 px-4 text-xs text-slate-400 hover:text-red-500 transition-colors">
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Preview Area -->
            <div
                class="hidden md:flex flex-1 bg-slate-800 rounded-xl border border-slate-700 shadow-xl flex-col overflow-hidden relative">
                <div class="bg-slate-900 px-4 py-2 flex items-center justify-between border-b border-slate-700">
                    <span id="preview-filename" class="text-slate-200 text-sm font-medium truncate max-w-[300px]">Select
                        a file to preview</span>
                    <span id="preview-badge"
                        class="px-2 py-0.5 rounded text-xs font-mono bg-slate-700 text-slate-300">Original</span>
                </div>
                <div id="empty-preview" class="flex-1 flex flex-col items-center justify-center text-slate-500">
                    <i data-lucide="eye" class="w-12 h-12 mb-2 opacity-50"></i>
                    <p>Select a file from the list to preview</p>
                </div>
                <iframe id="pdf-preview" class="hidden w-full h-full bg-white" title="PDF Preview"></iframe>
            </div>

        </div>
    </main>

    <!-- Templates -->
    <template id="file-item-template">
        <li
            class="group p-3 bg-white border border-slate-200 rounded-lg flex items-center gap-3 cursor-pointer hover:border-blue-400 hover:shadow-sm transition-all relative overflow-hidden">
            <div class="icon-container bg-slate-100 p-2 rounded text-slate-500">
                <i data-lucide="file" class="w-5 h-5"></i>
            </div>
            <div class="flex-1 min-w-0">
                <div class="file-name text-sm font-medium text-slate-700 truncate">filename.pdf</div>
                <div class="file-meta text-xs text-slate-400 flex items-center gap-2">
                    <span class="file-size">0 MB</span>
                    <span class="status-text hidden"></span>
                </div>
            </div>
            <div class="actions flex items-center gap-1">
                <!-- Status Icons -->
                <div class="status-icon hidden"></div>
                <!-- Action Buttons -->
                <button class="download-btn hidden p-1.5 text-green-600 hover:bg-green-50 rounded" title="Download">
                    <i data-lucide="download" class="w-4 h-4"></i>
                </button>
                <button class="remove-btn p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded"
                    title="Remove">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </li>
    </template>

    <script>
        // --- State ---
        let filesQueue = []; // Array of { id, file, originalUrl, processedBlob, processedUrl, status }
        let selectedFileId = null;
        let isProcessing = false;

        // --- Elements ---
        const uploadSection = document.getElementById('upload-section');
        const mainInterface = document.getElementById('main-interface');
        const fileInput = document.getElementById('file-input');
        const fileListEl = document.getElementById('file-list');
        const fileCountEl = document.getElementById('file-count');

        const previewFrame = document.getElementById('pdf-preview');
        const emptyPreview = document.getElementById('empty-preview');
        const previewFilename = document.getElementById('preview-filename');
        const previewBadge = document.getElementById('preview-badge');

        const processAllBtn = document.getElementById('process-all-btn');
        const downloadActions = document.getElementById('download-actions');
        const downloadZipBtn = document.getElementById('download-zip-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const addMoreBtn = document.getElementById('add-more-btn');

        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            waitForLibraries();
        });

        function waitForLibraries() {
            if (typeof PDFLib !== 'undefined' && typeof JSZip !== 'undefined') {
                loadingIndicator.classList.add('hidden');
            } else {
                loadingIndicator.classList.remove('hidden');
                setTimeout(waitForLibraries, 500);
            }
        }

        // --- Event Listeners ---

        // Drag & Drop
        uploadSection.addEventListener('click', () => fileInput.click());
        addMoreBtn.addEventListener('click', () => fileInput.click());

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        uploadSection.addEventListener('dragover', () => uploadSection.classList.add('border-blue-400', 'bg-blue-50'));
        uploadSection.addEventListener('dragleave', () => uploadSection.classList.remove('border-blue-400', 'bg-blue-50'));
        uploadSection.addEventListener('drop', (e) => {
            uploadSection.classList.remove('border-blue-400', 'bg-blue-50');
            handleFiles(e.dataTransfer.files);
        });

        // File Input
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        // Buttons
        processAllBtn.addEventListener('click', processQueue);
        clearAllBtn.addEventListener('click', clearAll);
        downloadZipBtn.addEventListener('click', generateZip);


        // --- Logic ---

        function handleFiles(fileList) {
            if (!fileList || fileList.length === 0) return;

            Array.from(fileList).forEach(file => {
                if (file.type !== 'application/pdf') return;

                // Create ID
                const id = Math.random().toString(36).substr(2, 9);

                filesQueue.push({
                    id,
                    file,
                    originalUrl: URL.createObjectURL(file),
                    processedBlob: null,
                    processedUrl: null,
                    status: 'pending' // pending, processing, success, error
                });
            });

            updateUI();

            // Auto-select first file if none selected
            if (!selectedFileId && filesQueue.length > 0) {
                selectFile(filesQueue[filesQueue.length - fileList.length].id);
            }
        }

        function updateUI() {
            // Toggle Views
            if (filesQueue.length > 0) {
                uploadSection.classList.add('hidden');
                mainInterface.classList.remove('hidden');
            } else {
                uploadSection.classList.remove('hidden');
                mainInterface.classList.add('hidden');
            }

            fileCountEl.textContent = filesQueue.length;
            renderFileList();
            updateActionButtons();
        }

        function renderFileList() {
            fileListEl.innerHTML = '';
            const template = document.getElementById('file-item-template');

            filesQueue.forEach(item => {
                const clone = template.content.cloneNode(true);
                const li = clone.querySelector('li');

                // Content
                clone.querySelector('.file-name').textContent = item.file.name;
                clone.querySelector('.file-size').textContent = (item.file.size / 1024 / 1024).toFixed(2) + ' MB';

                // Selection State
                if (item.id === selectedFileId) {
                    li.classList.add('border-blue-500', 'bg-blue-50');
                    li.classList.remove('border-slate-200');
                }

                // Click to Select
                li.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) selectFile(item.id);
                });

                // Remove Button
                const removeBtn = clone.querySelector('.remove-btn');
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeFile(item.id);
                };

                // Download Button (only if success)
                const downloadBtn = clone.querySelector('.download-btn');
                if (item.status === 'success') {
                    downloadBtn.classList.remove('hidden');
                    downloadBtn.onclick = (e) => {
                        e.stopPropagation();
                        downloadSingle(item);
                    };
                }

                // Status Icons & Styling
                const statusIconContainer = clone.querySelector('.status-icon');
                const statusText = clone.querySelector('.status-text');
                const iconContainer = clone.querySelector('.icon-container');

                if (item.status === 'processing') {
                    statusIconContainer.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 text-blue-600 spin"></i>`;
                    statusIconContainer.classList.remove('hidden');
                    statusText.textContent = "Processing...";
                    statusText.classList.remove('hidden', 'text-slate-400');
                    statusText.classList.add('text-blue-600');
                } else if (item.status === 'success') {
                    statusIconContainer.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>`;
                    statusIconContainer.classList.remove('hidden');
                    iconContainer.classList.replace('text-slate-500', 'text-green-600');
                    iconContainer.classList.replace('bg-slate-100', 'bg-green-100');
                } else if (item.status === 'error') {
                    statusIconContainer.innerHTML = `<i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i>`;
                    statusIconContainer.classList.remove('hidden');
                    statusText.textContent = "Error";
                    statusText.classList.remove('hidden');
                    statusText.classList.add('text-red-500');
                }

                fileListEl.appendChild(li);
            });
            lucide.createIcons();
        }

        function selectFile(id) {
            selectedFileId = id;
            const item = filesQueue.find(f => f.id === id);
            if (!item) return;

            // Render List again to update selection highlight
            renderFileList();

            // Update Preview
            emptyPreview.classList.add('hidden');
            previewFrame.classList.remove('hidden');

            previewFilename.textContent = item.file.name;

            if (item.status === 'success' && item.processedUrl) {
                previewFrame.src = `${item.processedUrl}#toolbar=0&navpanes=0`;
                previewBadge.textContent = "Result";
                previewBadge.classList.replace('bg-slate-700', 'bg-green-600');
            } else {
                previewFrame.src = `${item.originalUrl}#toolbar=0&navpanes=0`;
                previewBadge.textContent = "Original";
                previewBadge.classList.replace('bg-green-600', 'bg-slate-700');
            }
        }

        function removeFile(id) {
            const item = filesQueue.find(f => f.id === id);
            if (item) {
                URL.revokeObjectURL(item.originalUrl);
                if (item.processedUrl) URL.revokeObjectURL(item.processedUrl);
            }

            filesQueue = filesQueue.filter(f => f.id !== id);

            if (selectedFileId === id) {
                selectedFileId = null;
                previewFrame.classList.add('hidden');
                emptyPreview.classList.remove('hidden');
                previewFilename.textContent = "Select a file to preview";
                previewBadge.textContent = "";
            }

            updateUI();
        }

        function clearAll() {
            filesQueue.forEach(item => {
                URL.revokeObjectURL(item.originalUrl);
                if (item.processedUrl) URL.revokeObjectURL(item.processedUrl);
            });
            filesQueue = [];
            selectedFileId = null;
            updateUI();

            // Reset Preview
            previewFrame.classList.add('hidden');
            emptyPreview.classList.remove('hidden');

            // Reset Buttons
            processAllBtn.classList.remove('hidden');
            downloadActions.classList.add('hidden');
        }

        function updateActionButtons() {
            const hasSuccess = filesQueue.some(f => f.status === 'success');
            const allSuccess = filesQueue.length > 0 && filesQueue.every(f => f.status === 'success');

            if (allSuccess) {
                processAllBtn.classList.add('hidden');
                downloadActions.classList.remove('hidden');
            } else {
                processAllBtn.classList.remove('hidden');
                downloadActions.classList.add('hidden');
            }
        }

        // --- Processing Logic ---

        async function processQueue() {
            if (isProcessing) return;
            isProcessing = true;
            processAllBtn.disabled = true;
            processAllBtn.classList.add('opacity-75', 'cursor-not-allowed');

            progressContainer.classList.remove('hidden');

            const pendingItems = filesQueue.filter(f => f.status !== 'success');
            let processedCount = 0;
            const total = pendingItems.length;

            for (const item of pendingItems) {
                // Update UI to show processing
                item.status = 'processing';
                renderFileList();

                try {
                    const arrayBuffer = await item.file.arrayBuffer();
                    const { PDFDocument } = PDFLib;

                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    const form = pdfDoc.getForm();

                    try {
                        form.flatten();
                    } catch (e) {
                        console.log(`No forms to flatten in ${item.file.name}`);
                    }

                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });

                    item.processedBlob = blob;
                    item.processedUrl = URL.createObjectURL(blob);
                    item.status = 'success';
                } catch (err) {
                    console.error(err);
                    item.status = 'error';
                }

                processedCount++;
                const percentage = Math.round((processedCount / total) * 100);
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${percentage}%`;

                // Refresh list and preview if this was the selected file
                renderFileList();
                if (selectedFileId === item.id) selectFile(item.id);
            }

            isProcessing = false;
            processAllBtn.disabled = false;
            processAllBtn.classList.remove('opacity-75', 'cursor-not-allowed');
            progressContainer.classList.add('hidden');

            updateActionButtons();
        }

        // --- Download Logic ---

        function downloadSingle(item) {
            const link = document.createElement('a');
            link.href = item.processedUrl;
            link.download = `flattened_${item.file.name}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function generateZip() {
            const btn = downloadZipBtn;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 spin"></i> Zipping...`;

            try {
                const zip = new JSZip();

                filesQueue.forEach(item => {
                    if (item.status === 'success' && item.processedBlob) {
                        zip.file(`flattened_${item.file.name}`, item.processedBlob);
                    }
                });

                const content = await zip.generateAsync({ type: "blob" });
                const url = URL.createObjectURL(content);

                const link = document.createElement('a');
                link.href = url;
                link.download = "flattened_pdfs.zip";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

            } catch (err) {
                console.error("Zip error", err);
                alert("Failed to create ZIP file");
            } finally {
                btn.innerHTML = originalContent;
                lucide.createIcons();
            }
        }

    </script>
</body>

</html>